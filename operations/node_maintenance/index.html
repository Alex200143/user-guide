<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://kubevirt.io/user-guide/operations/node_maintenance/" />
      <link rel="shortcut icon" href="../../assets/favicon.ico" />
    <title>Node maintenance - KubeVirt User-Guide</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Node maintenance";
        var mkdocs_page_input_path = "operations/node_maintenance.md";
        var mkdocs_page_url = "/user-guide/operations/node_maintenance/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> KubeVirt User-Guide
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Welcome</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../quickstarts/">Quickstarts</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../release_notes/">KubeVirt release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Operations</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../updating_and_deletion/">Updating and deletion</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basic_use/">Basic use</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../customize_components/">Customize components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../api_validation/">API Validation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../debug/">Debug</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../virtctl_client_tool/">virtctl Client Tool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../live_migration/">Live Migration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../hotplug_volumes/">Hotplug Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../snapshot_restore_api/">Snapshot Restore API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../hugepages/">Hugepages support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../component_monitoring/">Component monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../authorization/">Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../annotations_and_labels/">Annotations and labels</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../node_assignment/">Node assignment</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Node maintenance</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#evict-all-vms-from-a-node">Evict all VMs from a Node</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#evict-all-vms-and-pods-from-a-node">Evict all VMs and Pods from a Node</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#evacuate-vmis-via-live-migration-from-a-node">Evacuate VMIs via Live Migration from a Node</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#re-enabling-a-node-after-eviction">Re-enabling a Node after Eviction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#shutting-down-a-node-after-eviction">Shutting down a Node after Eviction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#virtualmachine-evictions">VirtualMachine Evictions</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../node_overcommit/">Node overcommit</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../unresponsive_nodes/">Unresponsive nodes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../containerized_data_importer/">Containerized Data Importer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../activating_feature_gates/">Activating feature gates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../export_api/">Export API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../clone_api/">Clone API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../memory_dump/">Virtual machine memory dump</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../mediated_devices_configuration/">Mediated devices and virtual GPUs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../migration_policies/">Migration Policies</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Virtual machines</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/virtual_machine_instances/">Virtual Machines Instances</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/lifecycle/">Lifecycle</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/run_strategies/">Run Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/instancetypes/">Instancetypes and preferences</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/presets/">Presets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/virtual_hardware/">Virtual hardware</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/dedicated_cpu_resources/">Dedicated CPU resources</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/numa/">NUMA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/disks_and_volumes/">Disks and Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/interfaces_and_networks/">Interfaces and Networks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/istio_service_mesh/">Istio service mesh</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/networkpolicy/">NetworkPolicy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/host-devices/">Host Devices Assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/windows_virtio_drivers/">Windows virtio drivers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/guest_operating_system_information/">Guest Operating System Information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/guest_agent_information/">Guest Agent information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/liveness_and_readiness_probes/">Liveness and Readiness Probes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/accessing_virtual_machines/">Accessing Virtual Machines</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/startup_scripts/">Startup Scripts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/service_objects/">Service objects</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/templates/">Templates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/tekton_tasks/">KubeVirt Tekton</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/replicaset/">VirtualMachineInstanceReplicaSet</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/dns/">DNS records</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/boot_from_external_source/">Booting From External Source</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/confidential_computing/">Confidential computing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/vsock/">VSOCK</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../web_console/">Web Console</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/contributing/">Contributing</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">KubeVirt User-Guide</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Operations &raquo;</li>
      <li>Node maintenance</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/kubevirt/user-guide/edit/main/docs/operations/node_maintenance.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="node-maintenance">Node maintenance<a class="headerlink" href="#node-maintenance" title="Permanent link">&para;</a></h1>
<p>Before removing a kubernetes node from the cluster, users will want to
ensure that VirtualMachineInstances have been gracefully terminated
before powering down the node. Since all VirtualMachineInstances are
backed by a Pod, the recommended method of evicting
VirtualMachineInstances is to use the <strong>kubectl drain</strong> command, or in
the case of OKD the <strong>oc adm drain</strong> command.</p>
<h2 id="evict-all-vms-from-a-node">Evict all VMs from a Node<a class="headerlink" href="#evict-all-vms-from-a-node" title="Permanent link">&para;</a></h2>
<p>Select the node you'd like to evict VirtualMachineInstances from by
identifying the node from the list of cluster nodes.</p>
<p><code>kubectl get nodes</code></p>
<p>The following command will gracefully terminate all VMs on a specific
node. Replace <code>&lt;node-name&gt;</code> with the name of the node where the eviction should occur.</p>
<p><code>kubectl drain &lt;node-name&gt; --delete-local-data --ignore-daemonsets=true --force --pod-selector=kubevirt.io=virt-launcher</code></p>
<p>Below is a break down of why each argument passed to the drain command
is required.</p>
<ul>
<li>
<p><code>kubectl drain &lt;node-name&gt;</code> is selecting a specific node as a target
    for the eviction</p>
</li>
<li>
<p><code>--delete-local-data</code> is a required flag that is necessary for
    removing any pod that utilizes an emptyDir volume. The
    VirtualMachineInstance Pod does use emptyDir volumes, however the
    data in those volumes are ephemeral which means it is safe to delete
    after termination.</p>
</li>
<li>
<p><code>--ignore-daemonsets=true</code> is a required flag because every node
    running a VirtualMachineInstance will also be running our helper
    DaemonSet called virt-handler. DaemonSets are not allowed to be
    evicted using <strong>kubectl drain</strong>. By default, if this command
    encounters a DaemonSet on the target node, the command will fail.
    This flag tells the command it is safe to proceed with the eviction
    and to just ignore DaemonSets.</p>
</li>
<li>
<p><code>--force</code> is a required flag because VirtualMachineInstance pods are
    not owned by a ReplicaSet or DaemonSet controller. This means
    kubectl can't guarantee that the pods being terminated on the target
    node will get re-scheduled replacements placed else where in the
    cluster after the pods are evicted. KubeVirt has its own controllers
    which manage the underlying VirtualMachineInstance pods. Each
    controller behaves differently to a VirtualMachineInstance being
    evicted. That behavior is outlined further down in this document.</p>
</li>
<li>
<p><code>--pod-selector=kubevirt.io=virt-launcher</code> means only
    VirtualMachineInstance pods managed by KubeVirt will be removed from
    the node.</p>
</li>
</ul>
<h2 id="evict-all-vms-and-pods-from-a-node">Evict all VMs and Pods from a Node<a class="headerlink" href="#evict-all-vms-and-pods-from-a-node" title="Permanent link">&para;</a></h2>
<p>By removing the <code>-pod-selector</code> argument from the previous command, we
can issue the eviction of all Pods on a node. This command ensures Pods
associated with VMs as well as all other Pods are evicted from the
target node.</p>
<p><code>kubectl drain &lt;node name&gt; --delete-local-data --ignore-daemonsets=true --force</code></p>
<h2 id="evacuate-vmis-via-live-migration-from-a-node">Evacuate VMIs via Live Migration from a Node<a class="headerlink" href="#evacuate-vmis-via-live-migration-from-a-node" title="Permanent link">&para;</a></h2>
<p>If the <code>LiveMigration</code>
<a href="../activating_feature_gates/#how-to-activate-a-feature-gate">feature gate</a>
is enabled, it is possible to
specify an <code>evictionStrategy</code> on VMIs which will react with live-migrations on
specific taints on nodes. The following snippet on a VMI or the VMI templates in
a VM ensures that the VMI is migrated during node eviction:</p>
<pre><code>spec:
  evictionStrategy: LiveMigrate
</code></pre>
<p>Here a full VMI:</p>
<pre><code>apiVersion: kubevirt.io/v1
kind: VirtualMachineInstance
metadata:
  name: testvmi-nocloud
spec:
  terminationGracePeriodSeconds: 30
  evictionStrategy: LiveMigrate
  domain:
    resources:
      requests:
        memory: 1024M
    devices:
      disks:
      - name: containerdisk
        disk:
          bus: virtio
      - disk:
          bus: virtio
        name: cloudinitdisk
  volumes:
  - name: containerdisk
    containerDisk:
      image: kubevirt/fedora-cloud-container-disk-demo:latest
  - name: cloudinitdisk
    cloudInitNoCloud:
      userData: |-
        #cloud-config
        password: fedora
        chpasswd: { expire: False }
</code></pre>
<p>Behind the scenes a <strong>PodDisruptionBudget</strong> is created for each VMI
which has an <strong>evictionStrategy</strong> defined. This ensures that evictions
are be blocked on these VMIs and that we can guarantee that a VMI will
be migrated instead of shut off.</p>
<p><strong>Note</strong> Prior to v0.34 the drain process with live migrations was detached from
the <code>kubectl drain</code> itself and required in addition specifying a special taint
on the nodes: <code>kubectl taint nodes foo kubevirt.io/drain=draining:NoSchedule</code>.
This is no longer needed. The taint will still be respected if provided but is
<strong>obsolete</strong>.</p>
<h2 id="re-enabling-a-node-after-eviction">Re-enabling a Node after Eviction<a class="headerlink" href="#re-enabling-a-node-after-eviction" title="Permanent link">&para;</a></h2>
<p>The <strong>kubectl drain</strong> will result in the target node being marked as
unschedulable. This means the node will not be eligible for running new
VirtualMachineInstances or Pods.</p>
<p>If it is decided that the target node should become schedulable again,
the following command must be run.</p>
<p><code>kubectl uncordon &lt;node name&gt;</code></p>
<p>or in the case of OKD.</p>
<p><code>oc adm uncordon &lt;node name&gt;</code></p>
<h2 id="shutting-down-a-node-after-eviction">Shutting down a Node after Eviction<a class="headerlink" href="#shutting-down-a-node-after-eviction" title="Permanent link">&para;</a></h2>
<p>From KubeVirt's perspective, a node is safe to shutdown once all
VirtualMachineInstances have been evicted from the node. In a multi-use
cluster where VirtualMachineInstances are being scheduled alongside
other containerized workloads, it is up to the cluster admin to ensure
all other pods have been safely evicted before powering down the node.</p>
<h2 id="virtualmachine-evictions">VirtualMachine Evictions<a class="headerlink" href="#virtualmachine-evictions" title="Permanent link">&para;</a></h2>
<p>The eviction of any VirtualMachineInstance that is owned by a
VirtualMachine set to <strong>running=true</strong> will result in the
VirtualMachineInstance being re-scheduled to another node.</p>
<p>The VirtualMachineInstance in this case will be forced to power down and
restart on another node. In the future once KubeVirt introduces live
migration support, the VM will be able to seamlessly migrate to another
node during eviction.</p>
<h3 id="virtualmachineinstancereplicaset-eviction-behavior">VirtualMachineInstanceReplicaSet Eviction Behavior<a class="headerlink" href="#virtualmachineinstancereplicaset-eviction-behavior" title="Permanent link">&para;</a></h3>
<p>The eviction of VirtualMachineInstances owned by a
VirtualMachineInstanceReplicaSet will result in the
VirtualMachineInstanceReplicaSet scheduling replacements for the evicted
VirtualMachineInstances on other nodes in the cluster.</p>
<h3 id="virtualmachineinstance-eviction-behavior">VirtualMachineInstance Eviction Behavior<a class="headerlink" href="#virtualmachineinstance-eviction-behavior" title="Permanent link">&para;</a></h3>
<p>VirtualMachineInstances not backed by either a
VirtualMachineInstanceReplicaSet or an VirtualMachine object will not be
re-scheduled after eviction.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../node_assignment/" class="btn btn-neutral float-left" title="Node assignment"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../node_overcommit/" class="btn btn-neutral float-right" title="Node overcommit">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/kubevirt/user-guide/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../node_assignment/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../node_overcommit/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

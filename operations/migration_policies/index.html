<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://kubevirt.io/user-guide/operations/migration_policies/" />
      <link rel="shortcut icon" href="../../assets/favicon.ico" />
    <title>Migration Policies - KubeVirt User-Guide</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Migration Policies";
        var mkdocs_page_input_path = "operations/migration_policies.md";
        var mkdocs_page_url = "/user-guide/operations/migration_policies/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> KubeVirt User-Guide
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Welcome</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../quickstarts/">Quickstarts</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../release_notes/">KubeVirt release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Operations</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../updating_and_deletion/">Updating and deletion</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basic_use/">Basic use</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../customize_components/">Customize components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../api_validation/">API Validation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../debug/">Debug</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../virtctl_client_tool/">virtctl Client Tool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../live_migration/">Live Migration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../hotplug_volumes/">Hotplug Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../snapshot_restore_api/">Snapshot Restore API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../hugepages/">Hugepages support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../component_monitoring/">Component monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../authorization/">Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../annotations_and_labels/">Annotations and labels</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../node_assignment/">Node assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../node_maintenance/">Node maintenance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../node_overcommit/">Node overcommit</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../unresponsive_nodes/">Unresponsive nodes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../containerized_data_importer/">Containerized Data Importer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../activating_feature_gates/">Activating feature gates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../export_api/">Export API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../clone_api/">Clone API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../memory_dump/">Virtual machine memory dump</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../mediated_devices_configuration/">Mediated devices and virtual GPUs</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Migration Policies</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#api-examples">API Examples</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#policies-precedence">Policies' Precedence</a>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Virtual machines</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/virtual_machine_instances/">Virtual Machines Instances</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/lifecycle/">Lifecycle</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/run_strategies/">Run Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/instancetypes/">Instancetypes and preferences</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/presets/">Presets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/virtual_hardware/">Virtual hardware</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/dedicated_cpu_resources/">Dedicated CPU resources</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/numa/">NUMA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/disks_and_volumes/">Disks and Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/interfaces_and_networks/">Interfaces and Networks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/istio_service_mesh/">Istio service mesh</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/networkpolicy/">NetworkPolicy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/host-devices/">Host Devices Assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/windows_virtio_drivers/">Windows virtio drivers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/guest_operating_system_information/">Guest Operating System Information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/guest_agent_information/">Guest Agent information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/liveness_and_readiness_probes/">Liveness and Readiness Probes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/accessing_virtual_machines/">Accessing Virtual Machines</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/startup_scripts/">Startup Scripts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/service_objects/">Service objects</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/templates/">Templates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/tekton_tasks/">KubeVirt Tekton</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/replicaset/">VirtualMachineInstanceReplicaSet</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/dns/">DNS records</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/boot_from_external_source/">Booting From External Source</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/confidential_computing/">Confidential computing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/vsock/">VSOCK</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../web_console/">Web Console</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/contributing/">Contributing</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">KubeVirt User-Guide</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Operations &raquo;</li>
      <li>Migration Policies</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/kubevirt/user-guide/edit/main/docs/operations/migration_policies.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="migration-policies">Migration Policies<a class="headerlink" href="#migration-policies" title="Permanent link">&para;</a></h1>
<p>Migration policies provides a new way of applying migration configurations to Virtual Machines. The policies
can refine Kubevirt CR's <code>MigrationConfiguration</code> that sets the cluster-wide migration configurations. This way,
the cluster-wide settings serve as a default that can be refined (i.e. changed, removed or added) by the migration
policy.</p>
<p>Please bear in mind that migration policies are in version <code>v1alpha1</code>. This means that this API is not fully stable
yet and that APIs may change in the future.</p>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>KubeVirt supports <a href="../live_migration/">Live Migrations</a> of Virtual Machine workloads.
Before migration policies were introduced, migration settings could be configurable only on the cluster-wide
scope by editing <a href="https://kubevirt.io/api-reference/master/definitions.html#_v1_kubevirtspec">KubevirtCR's spec</a>
or more specifically <a href="https://kubevirt.io/api-reference/master/definitions.html#_v1_migrationconfiguration">MigrationConfiguration</a>
CRD.</p>
<p>Several aspects (although not all) of migration behaviour that can be customized are:
- Bandwidth
- Auto-convergence
- Post/Pre-copy
- Max number of parallel migrations
- Timeout</p>
<p>Migration policies generalize the concept of defining migration configurations, so it would be
possible to apply different configurations to specific groups of VMs.</p>
<p>Such capability can be useful for a lot of different use cases on which there is a need to differentiate
between different workloads. Differentiation of different configurations could be needed because different
workloads are considered to be in different priorities, security segregation, workloads with different
requirements, help to converge workloads which aren't migration-friendly, and many other reasons.</p>
<h2 id="api-examples">API Examples<a class="headerlink" href="#api-examples" title="Permanent link">&para;</a></h2>
<h4 id="migration-configurations">Migration Configurations<a class="headerlink" href="#migration-configurations" title="Permanent link">&para;</a></h4>
<p>Currently the MigrationPolicy spec will only include the following configurations from KubevirtCR's
MigrationConfiguration (in the future more configurations that aren't part of Kubevirt CR are intended to be added):</p>
<pre><code class="language-yaml">apiVersion: migrations.kubevirt.io/v1alpha1
kind: MigrationPolicy
  spec:
    allowAutoConverge: true
    bandwidthPerMigration: 217Ki
    completionTimeoutPerGiB: 23
    allowPostCopy: false
</code></pre>
<p>All above fields are optional. When omitted, the configuration will be applied as defined in
KubevirtCR's MigrationConfiguration. This way, KubevirtCR will serve as a configurable set of defaults for both
VMs that are not bound to any MigrationPolicy and VMs that are bound to a MigrationPolicy that does not
define all fields of the configurations.</p>
<h4 id="matching-policies-to-vms">Matching Policies to VMs<a class="headerlink" href="#matching-policies-to-vms" title="Permanent link">&para;</a></h4>
<p>Next in the spec are the selectors that define the group of VMs on which to apply the policy. The options to do so
are the following.</p>
<p><strong>This policy applies to the VMs in namespaces that have all the required labels:</strong></p>
<pre><code class="language-yaml">apiVersion: migrations.kubevirt.io/v1alpha1
kind: MigrationPolicy
  spec:
  selectors:
    namespaceSelector:
      matchLabels:
        hpc-workloads: true       # Matches a key and a value 
</code></pre>
<p><strong>This policy applies for the VMs that have all the required labels:</strong></p>
<pre><code class="language-yaml">apiVersion: migrations.kubevirt.io/v1alpha1
kind: MigrationPolicy
  spec:
  selectors:
    virtualMachineInstanceSelector:
      matchLabels:
        workload-type: db       # Matches a key and a value 
</code></pre>
<p><strong>It is also possible to combine the previous two:</strong></p>
<pre><code class="language-yaml">apiVersion: migrations.kubevirt.io/v1alpha1
kind: MigrationPolicy
  spec:
  selectors:
    namespaceSelector:
      matchLabels:
        hpc-workloads: true
    virtualMachineInstanceSelector:
      matchLabels:
        workload-type: db
</code></pre>
<h4 id="full-manifest">Full Manifest:<a class="headerlink" href="#full-manifest" title="Permanent link">&para;</a></h4>
<pre><code class="language-yaml">apiVersion: migrations.kubevirt.io/v1alpha1
kind: MigrationPolicy
metadata:
  name: my-awesome-policy
spec:
  # Migration Configuration
  allowAutoConverge: true
  bandwidthPerMigration: 217Ki
  completionTimeoutPerGiB: 23
  allowPostCopy: false

  # Matching to VMs
  selectors:
    namespaceSelector:
      matchLabels:
        hpc-workloads: true
    virtualMachineInstanceSelector:
      matchLabels:
        workload-type: db
</code></pre>
<h2 id="policies-precedence">Policies' Precedence<a class="headerlink" href="#policies-precedence" title="Permanent link">&para;</a></h2>
<p>It is possible that multiple policies apply to the same VMI. In such cases, the precedence is in the
same order as the bullets above (VMI labels first, then namespace labels). It is not allowed to define
two policies with the exact same selectors.</p>
<p>If multiple policies apply to the same VMI:
* The most detailed policy will be applied, that is, the policy with the highest number of matching labels</p>
<ul>
<li>If multiple policies match to a VMI with the same number of matching labels, the policies will be sorted by the
lexicographic order of the matching labels keys. The first one in this order will be applied.</li>
</ul>
<h3 id="example">Example<a class="headerlink" href="#example" title="Permanent link">&para;</a></h3>
<p>For example, let's imagine a VMI with the following labels:</p>
<ul>
<li>
<p>size: small</p>
</li>
<li>
<p>os: fedora</p>
</li>
<li>
<p>gpu: nvidia</p>
</li>
</ul>
<p>And let's say the namespace to which the VMI belongs contains the following labels:</p>
<ul>
<li>
<p>priority: high</p>
</li>
<li>
<p>bandwidth: medium</p>
</li>
<li>
<p>hpc-workload: true</p>
</li>
</ul>
<p>The following policies are listed by their precedence (high to low):</p>
<p>1) VMI labels: <code>{size: small, gpu: nvidia}</code>, Namespace labels: <code>{priority:high, bandwidth: medium}</code></p>
<ul>
<li>Matching labels: 4, First key in lexicographic order: <code>bandwidth</code>.</li>
</ul>
<p>2) VMI labels: <code>{size: small, gpu: nvidia}</code>, Namespace labels: <code>{priority:high, hpc-workload:true}</code></p>
<ul>
<li>Matching labels: 4, First key in lexicographic order: <code>gpu</code>.</li>
</ul>
<p>3) VMI labels: <code>{size: small, gpu: nvidia}</code>, Namespace labels: <code>{priority:high}</code></p>
<ul>
<li>Matching labels: 3, First key in lexicographic order: <code>gpu</code>.</li>
</ul>
<p>4) VMI labels: <code>{size: small}</code>, Namespace labels: <code>{priority:high, hpc-workload:true}</code></p>
<ul>
<li>Matching labels: 3, First key in lexicographic order: <code>hpc-workload</code>.</li>
</ul>
<p>5) VMI labels: <code>{gpu: nvidia}</code>, Namespace labels: <code>{priority:high}</code></p>
<ul>
<li>Matching labels: 2, First key in lexicographic order: <code>gpu</code>.</li>
</ul>
<p>6) VMI labels: <code>{gpu: nvidia}</code>, Namespace labels: <code>{}</code></p>
<ul>
<li>Matching labels: 1, First key in lexicographic order: <code>gpu</code>.</li>
</ul>
<p>7) VMI labels: <code>{gpu: intel}</code>, Namespace labels: <code>{priority:high}</code></p>
<ul>
<li>VMI label does not match - policy cannot be applied.</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../mediated_devices_configuration/" class="btn btn-neutral float-left" title="Mediated devices and virtual GPUs"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../virtual_machines/virtual_machine_instances/" class="btn btn-neutral float-right" title="Virtual Machines Instances">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/kubevirt/user-guide/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../mediated_devices_configuration/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../virtual_machines/virtual_machine_instances/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://kubevirt.io/user-guide/operations/memory_dump/" />
      <link rel="shortcut icon" href="../../assets/favicon.ico" />
    <title>Virtual machine memory dump - KubeVirt User-Guide</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Virtual machine memory dump";
        var mkdocs_page_input_path = "operations/memory_dump.md";
        var mkdocs_page_url = "/user-guide/operations/memory_dump/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> KubeVirt User-Guide
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Welcome</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../quickstarts/">Quickstarts</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../release_notes/">KubeVirt release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Operations</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../updating_and_deletion/">Updating and deletion</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basic_use/">Basic use</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../customize_components/">Customize components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../api_validation/">API Validation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../debug/">Debug</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../virtctl_client_tool/">virtctl Client Tool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../live_migration/">Live Migration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../hotplug_volumes/">Hotplug Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../snapshot_restore_api/">Snapshot Restore API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../hugepages/">Hugepages support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../component_monitoring/">Component monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../authorization/">Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../annotations_and_labels/">Annotations and labels</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../node_assignment/">Node assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../node_maintenance/">Node maintenance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../node_overcommit/">Node overcommit</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../unresponsive_nodes/">Unresponsive nodes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../containerized_data_importer/">Containerized Data Importer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../activating_feature_gates/">Activating feature gates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../export_api/">Export API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../clone_api/">Clone API</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Virtual machine memory dump</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#virtctl-support">Virtctl support</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#handle-the-memory-dump">Handle the memory dump</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../mediated_devices_configuration/">Mediated devices and virtual GPUs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../migration_policies/">Migration Policies</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Virtual machines</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/virtual_machine_instances/">Virtual Machines Instances</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/lifecycle/">Lifecycle</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/run_strategies/">Run Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/instancetypes/">Instancetypes and preferences</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/presets/">Presets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/virtual_hardware/">Virtual hardware</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/dedicated_cpu_resources/">Dedicated CPU resources</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/numa/">NUMA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/disks_and_volumes/">Disks and Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/interfaces_and_networks/">Interfaces and Networks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/istio_service_mesh/">Istio service mesh</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/networkpolicy/">NetworkPolicy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/host-devices/">Host Devices Assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/windows_virtio_drivers/">Windows virtio drivers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/guest_operating_system_information/">Guest Operating System Information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/guest_agent_information/">Guest Agent information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/liveness_and_readiness_probes/">Liveness and Readiness Probes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/accessing_virtual_machines/">Accessing Virtual Machines</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/startup_scripts/">Startup Scripts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/service_objects/">Service objects</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/templates/">Templates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/tekton_tasks/">KubeVirt Tekton</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/replicaset/">VirtualMachineInstanceReplicaSet</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/dns/">DNS records</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/boot_from_external_source/">Booting From External Source</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/confidential_computing/">Confidential computing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/vsock/">VSOCK</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../web_console/">Web Console</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/contributing/">Contributing</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">KubeVirt User-Guide</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Operations &raquo;</li>
      <li>Virtual machine memory dump</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/kubevirt/user-guide/edit/main/docs/operations/memory_dump.md"
          class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="virtual-machine-memory-dump">Virtual machine memory dump<a class="headerlink" href="#virtual-machine-memory-dump" title="Permanent link">&para;</a></h1>
<p>Kubevirt now supports getting a VM memory dump for analysis purposes.
The Memory dump can be used to diagnose, identify and resolve issues in the VM. Typically providing information about the last state of the programs, applications and system before they were terminated or crashed.</p>
<blockquote>
<p><em>Note</em> This memory dump is not used for saving VM state and resuming it later.</p>
</blockquote>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h2>
<h3 id="hot-plug-feature-gate">Hot plug Feature Gate<a class="headerlink" href="#hot-plug-feature-gate" title="Permanent link">&para;</a></h3>
<p>The memory dump process mounts a PVC to the virt-launcher in order to get the output in that PVC, hence the hot plug volumes feature gate must be enabled. The
<a href="../activating_feature_gates/#how-to-activate-a-feature-gate">feature gates</a>
field in the KubeVirt CR must be expanded by adding the <code>HotplugVolumes</code> to it.</p>
<h2 id="virtctl-support">Virtctl support<a class="headerlink" href="#virtctl-support" title="Permanent link">&para;</a></h2>
<h3 id="get-memory-dump">Get memory dump<a class="headerlink" href="#get-memory-dump" title="Permanent link">&para;</a></h3>
<p>Now lets assume we have a running VM and the name of the VM is 'my-vm'.
We can either dump to an existing pvc, or request one to be created.</p>
<h4 id="existing-pvc">Existing PVC<a class="headerlink" href="#existing-pvc" title="Permanent link">&para;</a></h4>
<p>The size of the PVC must be big enough to hold the memory dump. The calculation is (VMMemorySize + 100Mi) * FileSystemOverhead, Where <code>VMMemorySize</code> is the memory size,
100Mi is reserved space for the memory dump overhead and <code>FileSystemOverhead</code> is the value used to adjust requested PVC size with the filesystem overhead.
also the PVC must have a <code>FileSystem</code> volume mode.</p>
<p>Example for such PVC:</p>
<pre><code class="language-yaml">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
  storageClassName: rook-ceph-block
  volumeMode: Filesystem
</code></pre>
<p>We can get a memory dump of the VM to the PVC by using the 'memory-dump get' command available with virtctl</p>
<pre><code class="language-bash">$ virtctl memory-dump get my-vm --claim-name=my-pvc
</code></pre>
<h4 id="on-demand-pvc">On demand PVC<a class="headerlink" href="#on-demand-pvc" title="Permanent link">&para;</a></h4>
<p>For on demand PVC, we need to add <code>--create-claim</code> flag to the virtctl request:</p>
<pre><code class="language-bash">$ virtctl memory-dump get my-vm --claim-name=new-pvc --create-claim
</code></pre>
<p>A PVC with size big enough for the dump will be created. We can also request specific storage class and access mode with appropriate flags.</p>
<h3 id="monitoring-the-memory-dump">Monitoring the memory dump<a class="headerlink" href="#monitoring-the-memory-dump" title="Permanent link">&para;</a></h3>
<p>Information regarding the memory dump process will be available on the VM's status section</p>
<pre><code class="language-yaml">    memoryDumpRequest:
      claimName: memory-dump
      phase: Completed
      startTimestamp: &quot;2022-03-29T11:00:04Z&quot;
      endTimestamp: &quot;2022-03-29T11:00:09Z&quot;
      fileName: my-vm-my-pvc-20220329-110004
</code></pre>
<p>During the process the volumeStatus on the VMI will be updated with the process information such as the attachment pod information and messages, if all goes well once the process is completed, the PVC is unmounted from the virt-launcher pod and the volumeStatus is deleted.
A memory dump annotation will be added to the PVC with the memory dump file name.</p>
<h3 id="retriggering-the-memory-dump">Retriggering the memory dump<a class="headerlink" href="#retriggering-the-memory-dump" title="Permanent link">&para;</a></h3>
<p>Getting a new memory dump to the same PVC is possible without the need to use any flag:</p>
<pre><code class="language-bash">$ virtctl memory-dump get my-vm
</code></pre>
<blockquote>
<p><em>Note</em> Each memory-dump command will delete the previous dump in that PVC.</p>
</blockquote>
<p>In order to get a memory dump to a different PVC you need to 'remove' the current memory-dump PVC and then do a new get with the new PVC name.</p>
<h3 id="remove-memory-dump">Remove memory dump<a class="headerlink" href="#remove-memory-dump" title="Permanent link">&para;</a></h3>
<p>As mentioned in order to remove the associated memory dump PVC you need to run a 'memory-dump remove' command. This will allow you to replace the current PVC and get the memory dump to a new one.</p>
<pre><code class="language-bash">$ virtctl memory-dump remove my-vm
</code></pre>
<h2 id="handle-the-memory-dump">Handle the memory dump<a class="headerlink" href="#handle-the-memory-dump" title="Permanent link">&para;</a></h2>
<p>Once the memory dump process is completed the PVC will hold the output.
You can manage the dump in one of the following ways:
- Create a consumer pod for the PVC that will mount the PVC as a device, then copy the content out from the pod using <code>kubectl cp</code>
    yaml example:
    <code>yaml
    apiVersion: v1
    kind: Pod
    metadata:
      name: consumer-pod
    spec:
      volumes:
        - name: my-pvc
          persistentVolumeClaim:
            claimName: my-pvc
      containers:
      - name: pod-container
        image: busybox
        command: ['/bin/sh', '-c', 'while true; do echo hello; sleep 2;done']
        volumeMounts:
          - mountPath: /dev/pvc
            name: my-pvc</code></p>
<pre><code>kubectl cp example:
```bash
$ kubectl cp default/consumer-pod:/dev/pvc/ memory-dump
```
</code></pre>
<ul>
<li>Create a pod with troubleshooting tools that will mount the PVC and inspect it within the pod.</li>
<li>Use <a href="https://github.com/kubevirt/user-guide/blob/main/docs/operations/export_api.md">Export mechanism</a> by:<ul>
<li>Exporting the PVC</li>
<li>Include the memory dump in the VMSnapshot and export the whole VMSnapshot (will include both the memory dump and the disks)</li>
</ul>
</li>
</ul>
<p>The output of the memory dump can be inspected with memory analysis tools for example <a href="https://github.com/volatilityfoundation/volatility3">Volatility3</a></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../clone_api/" class="btn btn-neutral float-left" title="Clone API"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../mediated_devices_configuration/" class="btn btn-neutral float-right" title="Mediated devices and virtual GPUs">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/kubevirt/user-guide/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../clone_api/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../mediated_devices_configuration/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

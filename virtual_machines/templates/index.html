<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://kubevirt.io/user-guide/virtual_machines/templates/" />
      <link rel="shortcut icon" href="../../assets/favicon.ico" />
    <title>Templates - KubeVirt User-Guide</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Templates";
        var mkdocs_page_input_path = "virtual_machines/templates.md";
        var mkdocs_page_url = "/user-guide/virtual_machines/templates/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> KubeVirt User-Guide
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Welcome</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../release_notes/">KubeVirt release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Operations</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/updating_and_deletion/">Updating and deletion</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/basic_use/">Basic use</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/customize_components/">Customize components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/api_validation/">API Validation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/debug/">Debug</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/virtctl_client_tool/">virtctl Client Tool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/live_migration/">Live Migration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/hotplug_volumes/">Hotplug Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/snapshot_restore_api/">Snapshot Restore API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/hugepages/">Hugepages support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/component_monitoring/">Component monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/authorization/">Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/annotations_and_labels/">Annotations and labels</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_assignment/">Node assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_maintenance/">Node maintenance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_overcommit/">Node overcommit</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/unresponsive_nodes/">Unresponsive nodes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/containerized_data_importer/">Containerized Data Importer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/activating_feature_gates/">Activating feature gates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/export_api/">Export API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/clone_api/">Clone API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/memory_dump/">Virtual machine memory dump</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/mediated_devices_configuration/">Mediated devices and virtual GPUs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/migration_policies/">Migration Policies</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Virtual machines</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../virtual_machine_instances/">Virtual Machines Instances</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lifecycle/">Lifecycle</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../run_strategies/">Run Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../instancetypes/">Instancetypes and preferences</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../presets/">Presets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../virtual_hardware/">Virtual hardware</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dedicated_cpu_resources/">Dedicated CPU resources</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../numa/">NUMA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../disks_and_volumes/">Disks and Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../interfaces_and_networks/">Interfaces and Networks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../istio_service_mesh/">Istio service mesh</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../networkpolicy/">NetworkPolicy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../host-devices/">Host Devices Assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../windows_virtio_drivers/">Windows virtio drivers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guest_operating_system_information/">Guest Operating System Information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guest_agent_information/">Guest Agent information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../liveness_and_readiness_probes/">Liveness and Readiness Probes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../accessing_virtual_machines/">Accessing Virtual Machines</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../startup_scripts/">Startup Scripts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../service_objects/">Service objects</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Templates</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#virtual-machine-templates">Virtual machine templates</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#virtual-machine-creation">Virtual machine creation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#starting-virtual-machine-from-the-created-object">Starting virtual machine from the created object</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cloud-init-script-and-parameters">Cloud-init script and parameters</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#hack-use-pre-downloaded-image">Hack - use pre-downloaded image</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#using-datavolumes">Using DataVolumes</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#additional-information">Additional information</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tekton_tasks/">KubeVirt Tekton</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../replicaset/">VirtualMachineInstanceReplicaSet</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dns/">DNS records</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../boot_from_external_source/">Booting From External Source</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../confidential_computing/">Confidential computing</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../web_console/">Web Console</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/contributing/">Contributing</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">KubeVirt User-Guide</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Virtual machines &raquo;</li>
      <li>Templates</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/kubevirt/user-guide/edit/main/docs/virtual_machines/templates.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="templates">Templates<a class="headerlink" href="#templates" title="Permanent link">&para;</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By deploying KubeVirt on top of OpenShift the user can benefit from the <a href="https://docs.openshift.com/container-platform/4.10/virt/vm_templates/virt-creating-vm-template.html">OpenShift Template</a> functionality.</p>
</div>
<h2 id="virtual-machine-templates">Virtual machine templates<a class="headerlink" href="#virtual-machine-templates" title="Permanent link">&para;</a></h2>
<h3 id="what-is-a-virtual-machine-template">What is a virtual machine template?<a class="headerlink" href="#what-is-a-virtual-machine-template" title="Permanent link">&para;</a></h3>
<p>The KubeVirt projects provides a set of
<a href="https://docs.okd.io/latest/openshift_images/using-templates.html">templates</a> to
create VMs to handle common usage scenarios. These templates provide a
combination of some key factors that could be further customized and
processed to have a Virtual Machine object. The key factors which define
a template are</p>
<ul>
<li>
<p>Workload Most Virtual Machine should be <strong>server</strong> or <strong>desktop</strong> to have maximum
    flexibility; the <strong>highperformance</strong> workload trades some of this
    flexibility to provide better performances.</p>
</li>
<li>
<p>Guest Operating System (OS) This allow to ensure that the emulated
    hardware is compatible with the guest OS. Furthermore, it allows to
    maximize the stability of the VM, and allows performance
    optimizations.</p>
</li>
<li>
<p>Size (flavor) Defines the amount of resources (CPU, memory) to
    allocate to the VM.</p>
</li>
</ul>
<p>More documentation is available in the <a href="https://github.com/kubevirt/common-templates">common templates
subproject</a></p>
<h3 id="accessing-the-virtual-machine-templates">Accessing the virtual machine templates<a class="headerlink" href="#accessing-the-virtual-machine-templates" title="Permanent link">&para;</a></h3>
<p>If you installed KubeVirt using a supported method you should find the
common templates preinstalled in the cluster. Should you want to upgrade
the templates, or install them from scratch, you can use one of the
<a href="https://github.com/kubevirt/common-templates/releases">supported
releases</a></p>
<p>To install the templates:</p>
<pre><code class="language-console">    $ export VERSION=$(curl -s https://api.github.com/repos/kubevirt/common-templates/releases | grep tag_name | grep -v -- '-rc' | head -1 | awk -F': ' '{print $2}' | sed 's/,//' | xargs)
    $ oc create -f https://github.com/kubevirt/common-templates/releases/download/$VERSION/common-templates-$VERSION.yaml
</code></pre>
<h4 id="editable-fields">Editable fields<a class="headerlink" href="#editable-fields" title="Permanent link">&para;</a></h4>
<p>You can edit the fields of the templates which define the amount of
resources which the VMs will receive.</p>
<p>Each template can list a different set of fields that are to be
considered editable. The fields are used as hints for the user
interface, and also for other components in the cluster.</p>
<p>The editable fields are taken from annotations in the template. Here is
a snippet presenting a couple of most commonly found editable fields:</p>
<pre><code class="language-console">    metadata:
      annotations:
        template.kubevirt.io/editable: |
          /objects[0].spec.template.spec.domain.cpu.sockets
          /objects[0].spec.template.spec.domain.cpu.cores
          /objects[0].spec.template.spec.domain.cpu.threads
          /objects[0].spec.template.spec.domain.resources.requests.memory
</code></pre>
<p>Each entry in the editable field list must be a
<a href="https://kubernetes.io/docs/reference/kubectl/jsonpath/">jsonpath</a>. The
jsonpath root is the objects: element of the template. The actually
editable field is the last entry (the "leaf") of the path. For example,
the following minimal snippet highlights the fields which you can edit:</p>
<pre><code class="language-console">    objects:
      spec:
        template:
          spec:
            domain:
              cpu:
                sockets:
                  VALUE # this is editable
                cores:
                  VALUE # this is editable
                threads:
                  VALUE # this is editable
              resources:
                requests:
                  memory:
                    VALUE # this is editable
</code></pre>
<h3 id="relationship-between-templates-and-vms">Relationship between templates and VMs<a class="headerlink" href="#relationship-between-templates-and-vms" title="Permanent link">&para;</a></h3>
<p>Once processed the templates produce VM objects to be used in the cluster. The VMs
produced from templates will have a <code>vm.kubevirt.io/template</code> label,
whose value will be the name of the parent template, for example
<code>fedora-desktop-medium</code>:</p>
<pre><code class="language-console">      metadata:
        labels:
          vm.kubevirt.io/template: fedora-desktop-medium
</code></pre>
<p>In addition, these VMs can include an optional label
<code>vm.kubevirt.io/template-namespace</code>, whose value will be the namespace
of the parent template, for example:</p>
<pre><code class="language-console">      metadata:
        labels:
          vm.kubevirt.io/template-namespace: openshift
</code></pre>
<p>If this label is not defined, the template is expected to belong to the
same namespace as the VM.</p>
<p>This make it possible to query for all the VMs built from any template.</p>
<p>Example:</p>
<pre><code class="language-console">    oc process -o yaml -f dist/templates/rhel8-server-tiny.yaml NAME=rheltinyvm SRC_PVC_NAME=rhel SRC_PVC_NAMESPACE=kubevirt
</code></pre>
<p>And the output:</p>
<pre><code class="language-console">    apiVersion: v1
    items:
    - apiVersion: kubevirt.io/v1
      kind: VirtualMachine
      metadata:
        annotations:
          vm.kubevirt.io/flavor: tiny
          vm.kubevirt.io/os: rhel8
          vm.kubevirt.io/validations: |
            [
              {
                &quot;name&quot;: &quot;minimal-required-memory&quot;,
                &quot;path&quot;: &quot;jsonpath::.spec.domain.resources.requests.memory&quot;,
                &quot;rule&quot;: &quot;integer&quot;,
                &quot;message&quot;: &quot;This VM requires more memory.&quot;,
                &quot;min&quot;: 1610612736
              }
            ]
          vm.kubevirt.io/workload: server
        labels:
          app: rheltinyvm
          vm.kubevirt.io/template: rhel8-server-tiny
          vm.kubevirt.io/template.revision: &quot;45&quot;
          vm.kubevirt.io/template.version: 0.11.3
        name: rheltinyvm
      spec:
        dataVolumeTemplates:
        - apiVersion: cdi.kubevirt.io/v1beta1
          kind: DataVolume
          metadata:
            name: rheltinyvm
          spec:
            pvc:
              accessModes:
              - ReadWriteMany
              resources:
                requests:
                  storage: 30Gi
            source:
              pvc:
                name: rhel
                namespace: kubevirt
        running: false
        template:
          metadata:
            labels:
              kubevirt.io/domain: rheltinyvm
              kubevirt.io/size: tiny
          spec:
            domain:
              cpu:
                cores: 1
                sockets: 1
                threads: 1
              devices:
                disks:
                - disk:
                    bus: virtio
                  name: rheltinyvm
                - disk:
                    bus: virtio
                  name: cloudinitdisk
                interfaces:
                - masquerade: {}
                  name: default
                networkInterfaceMultiqueue: true
                rng: {}
              resources:
                requests:
                  memory: 1.5Gi
            networks:
            - name: default
              pod: {}
            terminationGracePeriodSeconds: 180
            volumes:
            - dataVolume:
                name: rheltinyvm
              name: rheltinyvm
            - cloudInitNoCloud:
                userData: |-
                  #cloud-config
                  user: cloud-user
                  password: lymp-fda4-m1cv
                  chpasswd: { expire: False }
              name: cloudinitdisk
    kind: List
    metadata: {}
</code></pre>
<p>You can add the VM from the template to the cluster in one go</p>
<pre><code class="language-console">    oc process rhel8-server-tiny NAME=rheltinyvm SRC_PVC_NAME=rhel SRC_PVC_NAMESPACE=kubevirt | oc apply -f -
</code></pre>
<p>Please note that after the generation step VM and template objects have no relationship with each other besides the aforementioned label.  Changes in templates do not automatically affect VMs or vice versa.</p>
<h3 id="common-template-customization">common template customization<a class="headerlink" href="#common-template-customization" title="Permanent link">&para;</a></h3>
<p>The templates provided by the kubevirt project provide a set of
conventions and annotations that augment the basic feature of the
<a href="https://docs.okd.io/latest/openshift_images/using-templates.html">openshift
templates</a>. You can
customize your kubevirt-provided templates editing these annotations, or
you can add them to your existing templates to make them consumable by
the kubevirt services.</p>
<p>Here's a description of the kubevirt annotations. Unless otherwise
specified, the following keys are meant to be top-level entries of the
template metadata, like</p>
<pre><code class="language-console">    apiVersion: v1
    kind: Template
    metadata:
      name: windows-10
      annotations:
        openshift.io/display-name: &quot;Generic demo template&quot;
</code></pre>
<p>All the following annotations are prefixed with
<code>defaults.template.kubevirt.io</code>, which is omitted below for brevity. So
the actual annotations you should use will look like</p>
<pre><code class="language-console">    apiVersion: v1
    kind: Template
    metadata:
      name: windows-10
      annotations:
        defaults.template.kubevirt.io/disk: default-disk
        defaults.template.kubevirt.io/volume: default-volume
        defaults.template.kubevirt.io/nic: default-nic
        defaults.template.kubevirt.io/network: default-network
</code></pre>
<p>Unless otherwise specified, all annotations are meant to be safe
defaults, both for performance and compatibility, and hints for the
CNV-aware UI and tooling.</p>
<h4 id="disk">disk<a class="headerlink" href="#disk" title="Permanent link">&para;</a></h4>
<p>See the section <code>references</code> below.</p>
<p>Example:</p>
<pre><code class="language-console">    apiVersion: v1
    kind: Template
    metadata:
      name: Linux
      annotations:
        defaults.template.kubevirt.io/disk: rhel-disk
</code></pre>
<h4 id="nic">nic<a class="headerlink" href="#nic" title="Permanent link">&para;</a></h4>
<p>See the section <code>references</code> below.</p>
<p>Example:</p>
<pre><code class="language-console">    apiVersion: v1
    kind: Template
    metadata:
      name: Windows
      annotations:
        defaults.template.kubevirt.io/nic: my-nic
</code></pre>
<h4 id="volume">volume<a class="headerlink" href="#volume" title="Permanent link">&para;</a></h4>
<p>See the section <code>references</code> below.</p>
<p>Example:</p>
<pre><code class="language-console">    apiVersion: v1
    kind: Template
    metadata:
      name: Linux
      annotations:
        defaults.template.kubevirt.io/volume: custom-volume
</code></pre>
<h4 id="network">network<a class="headerlink" href="#network" title="Permanent link">&para;</a></h4>
<p>See the section <code>references</code> below.</p>
<p>Example:</p>
<pre><code class="language-console">    apiVersion: v1
    kind: Template
    metadata:
      name: Linux
      annotations:
        defaults.template.kubevirt.io/network: fast-net
</code></pre>
<h4 id="references">references<a class="headerlink" href="#references" title="Permanent link">&para;</a></h4>
<p>The default values for network, nic, volume, disk are meant to be the
<strong>name</strong> of a section later in the document that the UI will find and
consume to find the default values for the corresponding types. For
example, considering the annotation
<code>defaults.template.kubevirt.io/disk: my-disk</code>: we assume that later in
the document it exists an element called <code>my-disk</code> that the UI can use
to find the data it needs. The names actually don't matter as long as
they are legal for kubernetes and consistent with the content of the
document.</p>
<h4 id="complete-example">complete example<a class="headerlink" href="#complete-example" title="Permanent link">&para;</a></h4>
<p><code>demo-template.yaml</code></p>
<pre><code class="language-console">apiversion: v1
items:
- apiversion: kubevirt.io/v1
  kind: virtualmachine
  metadata:
    labels:
      vm.kubevirt.io/template: rhel7-generic-tiny
    name: rheltinyvm
    osinfoname: rhel7.0
    defaults.template.kubevirt.io/disk: rhel-default-disk
    defaults.template.kubevirt.io/nic: rhel-default-net
  spec:
    running: false
    template:
      spec:
        domain:
          cpu:
            sockets: 1
            cores: 1
            threads: 1
          devices:
            rng: {}
          resources:
            requests:
              memory: 1g
        terminationgraceperiodseconds: 0
        volumes:
        - containerDisk:
          image: registry:5000/kubevirt/cirros-container-disk-demo:devel
          name: rhel-default-disk
        networks:
        - genie:
          networkName: flannel
          name: rhel-default-net
kind: list
metadata: {}
</code></pre>
<p>once processed becomes:
<code>demo-vm.yaml</code></p>
<pre><code class="language-console">apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  labels:
    vm.kubevirt.io/template: rhel7-generic-tiny
  name: rheltinyvm
  osinfoname: rhel7.0
spec:
  running: false
  template:
    spec:
      domain:
        cpu:
          sockets: 1
          cores: 1
          threads: 1
        resources:
          requests:
            memory: 1g
        devices:
          rng: {}
          disks:
          - disk:
            name: rhel-default-disk
        interfaces:
        - bridge: {}
          name: rhel-default-nic
      terminationgraceperiodseconds: 0
      volumes:
      - containerDisk:
          image: registry:5000/kubevirt/cirros-container-disk-demo:devel
        name: containerdisk
      networks:
      - genie:
          networkName: flannel
        name: rhel-default-nic
</code></pre>
<h2 id="virtual-machine-creation">Virtual machine creation<a class="headerlink" href="#virtual-machine-creation" title="Permanent link">&para;</a></h2>
<h3 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h3>
<p>The KubeVirt projects provides a set of
<a href="https://github.com/kubevirt/kubevirt/tree/main/examples">templates</a> to
create VMs to handle common usage scenarios. These templates provide a
combination of some key factors that could be further customized and
processed to have a Virtual Machine object.</p>
<p>The key factors which define a template are - Workload Most Virtual
Machine should be <strong>server</strong> or <strong>desktop</strong> to have maximum flexibility;
the <strong>highperformance</strong> workload trades some of this flexibility to
provide better performances. - Guest Operating System (OS) This allow to
ensure that the emulated hardware is compatible with the guest OS.
Furthermore, it allows to maximize the stability of the VM, and allows
performance optimizations. - Size (flavor) Defines the amount of
resources (CPU, memory) to allocate to the VM.</p>
<h3 id="openshift-console">Openshift Console<a class="headerlink" href="#openshift-console" title="Permanent link">&para;</a></h3>
<p>VMs can be created through <a href="https://github.com/openshift/console">OpenShift Cluster Console UI </a>.
This UI supports creation VM using templates and templates
features - flavors and workload profiles. To create VM from template, choose
WorkLoads in the left panel &gt;&gt; choose Virtualization &gt;&gt; press to the "Create Virtual Machine"
blue button &gt;&gt; choose "Create from wizard". Next, you have to see
"Create Virtual Machine" window</p>
<h3 id="common-templates">Common-templates<a class="headerlink" href="#common-templates" title="Permanent link">&para;</a></h3>
<p>There is the <a href="https://github.com/kubevirt/common-templates/">common-templates</a> subproject. It provides official prepared and useful templates. You can also create templates by hand. You can find an example below, in the "Example template" section.</p>
<h3 id="example-template">Example template<a class="headerlink" href="#example-template" title="Permanent link">&para;</a></h3>
<p>In order to create a virtual machine via OpenShift CLI, you need to
provide a template defining the corresponding object and its metadata.</p>
<p><strong>NOTE</strong> Only <code>VirtualMachine</code> object is currently supported.</p>
<p>Here is an example template that defines an instance of the
<code>VirtualMachine</code> object:</p>
<pre><code class="language-console">apiVersion: template.openshift.io/v1
kind: Template
metadata:
  name: fedora-desktop-large
  annotations:
    openshift.io/display-name: &quot;Fedora 32+ VM&quot;
    description: &gt;-
      Template for Fedora 32 VM or newer.
      A PVC with the Fedora disk image must be available.
      Recommended disk image:
      https://download.fedoraproject.org/pub/fedora/linux/releases/32/Cloud/x86_64/images/Fedora-Cloud-Base-32-1.6.x86_64.qcow2
    tags: &quot;hidden,kubevirt,virtualmachine,fedora&quot;
    iconClass: &quot;icon-fedora&quot;
    openshift.io/provider-display-name: &quot;KubeVirt&quot;
    openshift.io/documentation-url: &quot;https://github.com/kubevirt/common-templates&quot;
    openshift.io/support-url: &quot;https://github.com/kubevirt/common-templates/issues&quot;
    template.openshift.io/bindable: &quot;false&quot;
    template.kubevirt.io/version: v1alpha1
    defaults.template.kubevirt.io/disk: rootdisk
    template.kubevirt.io/editable: |
      /objects[0].spec.template.spec.domain.cpu.sockets
      /objects[0].spec.template.spec.domain.cpu.cores
      /objects[0].spec.template.spec.domain.cpu.threads
      /objects[0].spec.template.spec.domain.resources.requests.memory
      /objects[0].spec.template.spec.domain.devices.disks
      /objects[0].spec.template.spec.volumes
      /objects[0].spec.template.spec.networks
    name.os.template.kubevirt.io/fedora32: Fedora 32 or higher
    name.os.template.kubevirt.io/fedora33: Fedora 32 or higher
    name.os.template.kubevirt.io/silverblue32: Fedora 32 or higher
    name.os.template.kubevirt.io/silverblue33: Fedora 32 or higher
  labels:
    os.template.kubevirt.io/fedora32: &quot;true&quot;
    os.template.kubevirt.io/fedora33: &quot;true&quot;
    os.template.kubevirt.io/silverblue32: &quot;true&quot;
    os.template.kubevirt.io/silverblue33: &quot;true&quot;
    workload.template.kubevirt.io/desktop: &quot;true&quot;
    flavor.template.kubevirt.io/large: &quot;true&quot;
    template.kubevirt.io/type: &quot;base&quot;
    template.kubevirt.io/version: &quot;0.11.3&quot;
objects:
- apiVersion: kubevirt.io/v1
  kind: VirtualMachine
  metadata:
    name: ${NAME}
    labels:
      vm.kubevirt.io/template: fedora-desktop-large
      vm.kubevirt.io/template.version: &quot;0.11.3&quot;
      vm.kubevirt.io/template.revision: &quot;45&quot;
      app: ${NAME}
    annotations:
      vm.kubevirt.io/os: &quot;fedora&quot;
      vm.kubevirt.io/workload: &quot;desktop&quot;
      vm.kubevirt.io/flavor: &quot;large&quot;
      vm.kubevirt.io/validations: |
        [
          {
            &quot;name&quot;: &quot;minimal-required-memory&quot;,
            &quot;path&quot;: &quot;jsonpath::.spec.domain.resources.requests.memory&quot;,
            &quot;rule&quot;: &quot;integer&quot;,
            &quot;message&quot;: &quot;This VM requires more memory.&quot;,
            &quot;min&quot;: 1073741824
          }
        ]
  spec:
    dataVolumeTemplates:
    - apiVersion: cdi.kubevirt.io/v1beta1
      kind: DataVolume
      metadata:
        name: ${NAME}
      spec:
        pvc:
          accessModes:
            - ReadWriteMany
          resources:
            requests:
              storage: 30Gi
        source:
          pvc:
            name: ${SRC_PVC_NAME}
            namespace: ${SRC_PVC_NAMESPACE}
    running: false
    template:
      metadata:
        labels:
          kubevirt.io/domain: ${NAME}
          kubevirt.io/size: large
      spec:
        domain:
          cpu:
            sockets: 2
            cores: 1
            threads: 1
          resources:
            requests:
              memory: 8Gi
          devices:
            rng: {}
            networkInterfaceMultiqueue: true
            inputs:
              - type: tablet
                bus: virtio
                name: tablet
            disks:
            - disk:
                bus: virtio
              name: ${NAME}
            - disk:
                bus: virtio
              name: cloudinitdisk
            interfaces:
            - masquerade: {}
              name: default
        terminationGracePeriodSeconds: 180
        networks:
        - name: default
          pod: {}
        volumes:
        - dataVolume:
            name: ${NAME}
          name: ${NAME}
        - cloudInitNoCloud:
            userData: |-
              #cloud-config
              user: fedora
              password: ${CLOUD_USER_PASSWORD}
              chpasswd: { expire: False }
          name: cloudinitdisk
parameters:
- description: VM name
  from: 'fedora-[a-z0-9]{16}'
  generate: expression
  name: NAME
- name: SRC_PVC_NAME
  description: Name of the PVC to clone
  value: 'fedora'
- name: SRC_PVC_NAMESPACE
  description: Namespace of the source PVC
  value: kubevirt-os-images
- description: Randomized password for the cloud-init user fedora
  from: '[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}'
  generate: expression
  name: CLOUD_USER_PASSWORD
</code></pre>
<p>Note that the template above defines free parameters (<code>NAME</code>,
<code>SRC_PVC_NAME</code>, <code>SRC_PVC_NAMESPACE</code>, <code>CLOUD_USER_PASSWORD</code>) and the <code>NAME</code>
parameter does not have specified default value.</p>
<p>An OpenShift template has to be converted into the JSON file via
<code>oc process</code> command, that also allows you to set the template
parameters.</p>
<p>A complete example can be found in the <a href="https://raw.githubusercontent.com/kubevirt/kubevirt/main/examples/vm-template-fedora.yaml">KubeVirt
repository</a>.</p>
<p>!&gt; You need to be logged in by <code>oc login</code> command.</p>
<pre><code class="language-console">$ oc process -f cluster/vmi-template-fedora.yaml\
    -p NAME=testvmi \
    -p SRC_PVC_NAME=fedora \
    -p SRC_PVC_NAMESPACE=kubevirt \
{
    &quot;kind&quot;: &quot;List&quot;,
    &quot;apiVersion&quot;: &quot;v1&quot;,
    &quot;metadata&quot;: {},
    &quot;items&quot;: [
        {
</code></pre>
<p>The JSON file is usually applied directly by piping the processed output
to <code>oc create</code> command.</p>
<pre><code class="language-console">$ oc process -f cluster/examples/vm-template-fedora.yaml \
    -p NAME=testvm \
    -p SRC_PVC_NAME=fedora \
    -p SRC_PVC_NAMESPACE=kubevirt \
    | oc create -f -
virtualmachine.kubevirt.io/testvm created
</code></pre>
<p>The command above results in creating a Kubernetes object according to
the specification given by the template \(in this example it is an
instance of the VirtualMachine object\).</p>
<p>It's possible to get list of available parameters using the following
command:</p>
<pre><code class="language-console">$ oc process -f dist/templates/fedora-desktop-large.yaml --parameters
NAME                  DESCRIPTION                                          GENERATOR           VALUE
NAME                  VM name                                              expression          fedora-[a-z0-9]{16}
SRC_PVC_NAME          Name of the PVC to clone                                                 fedora
SRC_PVC_NAMESPACE     Namespace of the source PVC                                              kubevirt-os-images
CLOUD_USER_PASSWORD   Randomized password for the cloud-init user fedora   expression          [a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}
</code></pre>
<h2 id="starting-virtual-machine-from-the-created-object">Starting virtual machine from the created object<a class="headerlink" href="#starting-virtual-machine-from-the-created-object" title="Permanent link">&para;</a></h2>
<p>The created object is now a regular VirtualMachine object and from now
it can be controlled by accessing Kubernetes API resources. The
preferred way how to do this from within the OpenShift environment is to
use <code>oc patch</code> command.</p>
<pre><code class="language-console">$ oc patch virtualmachine testvm --type merge -p '{&quot;spec&quot;:{&quot;running&quot;:true}}'
virtualmachine.kubevirt.io/testvm patched
</code></pre>
<p>Do not forget about virtctl tool. Using it in the real cases instead of
using kubernetes API can be more convenient. Example:</p>
<pre><code class="language-console">$ virtctl start testvm
VM testvm was scheduled to start
</code></pre>
<p>As soon as VM starts, Kubernetes creates new type of object -
VirtualMachineInstance. It has similar name to VirtualMachine. Example
(not full output, it's too big):</p>
<pre><code class="language-console">$ kubectl describe vm testvm
name:         testvm
Namespace:    myproject
Labels:       kubevirt-vm=vm-testvm
              kubevirt.io/os=fedora33
Annotations:  &lt;none&gt;
API Version:  kubevirt.io/v1
Kind:         VirtualMachine
</code></pre>
<h2 id="cloud-init-script-and-parameters">Cloud-init script and parameters<a class="headerlink" href="#cloud-init-script-and-parameters" title="Permanent link">&para;</a></h2>
<p>Kubevirt VM templates, just like kubevirt VM/VMI yaml configs, supports
<a href="https://cloudinit.readthedocs.io/en/latest/">cloud-init scripts</a></p>
<h2 id="hack-use-pre-downloaded-image"><strong>Hack</strong> - use pre-downloaded image<a class="headerlink" href="#hack-use-pre-downloaded-image" title="Permanent link">&para;</a></h2>
<p>Kubevirt VM templates, just like kubevirt VM/VMI yaml configs, can use
pre-downloaded VM image, which can be a useful feature especially in the
debug/development/testing cases. No special parameters required in the
VM template or VM/VMI yaml config. The main idea is to create Kubernetes
PersistentVolume and PersistentVolumeClaim corresponding to existing
image in the file system. Example:</p>
<pre><code class="language-console">---
kind: PersistentVolume
apiVersion: v1
metadata:
  name: mypv
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 10G
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: &quot;/mnt/sda1/images/testvm&quot;
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: mypvc
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10G

</code></pre>
<h2 id="using-datavolumes">Using DataVolumes<a class="headerlink" href="#using-datavolumes" title="Permanent link">&para;</a></h2>
<p>Kubevirt VM templates are using dataVolumeTemplates.
Before using dataVolumes, CDI has to be installed in
cluster. After that, source Datavolume can be created.</p>
<pre><code class="language-console">---
apiVersion: cdi.kubevirt.io/v1beta1
kind: DataVolume
metadata:
  name: fedora-datavolume-original
  namespace: kubevirt
spec:
  source:
    registry:
      url: &quot;image_url&quot;
  pvc:
    accessModes:
      - ReadWriteOnce
    resources:
      requests:
        storage: 30Gi
</code></pre>
<p>After import is completed, VM can be created:</p>
<pre><code class="language-console">$ oc process -f cluster/examples/vm-template-fedora.yaml \
    -p NAME=testvmi \
    -p SRC_PVC_NAME=fedora-datavolume-original \
    -p SRC_PVC_NAMESPACE=kubevirt \
    | oc create -f -
virtualmachine.kubevirt.io/testvm created
</code></pre>
<h2 id="additional-information">Additional information<a class="headerlink" href="#additional-information" title="Permanent link">&para;</a></h2>
<p>You can follow <a href="../lifecycle/">Virtual Machine Lifecycle Guide</a> for further reference.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../service_objects/" class="btn btn-neutral float-left" title="Service objects"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../tekton_tasks/" class="btn btn-neutral float-right" title="KubeVirt Tekton">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/kubevirt/user-guide/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../service_objects/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../tekton_tasks/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://kubevirt.io/user-guide/virtual_machines/accessing_virtual_machines/" />
      <link rel="shortcut icon" href="../../assets/favicon.ico" />
    <title>Accessing Virtual Machines - KubeVirt User-Guide</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Accessing Virtual Machines";
        var mkdocs_page_input_path = "virtual_machines/accessing_virtual_machines.md";
        var mkdocs_page_url = "/user-guide/virtual_machines/accessing_virtual_machines/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> KubeVirt User-Guide
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Welcome</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../release_notes/">KubeVirt release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Operations</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/updating_and_deletion/">Updating and deletion</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/basic_use/">Basic use</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/api_validation/">API Validation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/debug/">Debug</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/virtctl_client_tool/">virtctl Client Tool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/live_migration/">Live Migration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/hotplug_volumes/">Hotplug Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/snapshot_restore_api/">Snapshot Restore API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/hugepages/">Hugepages support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/component_monitoring/">Component monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/authorization/">Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/annotations_and_labels/">Annotations and labels</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_assignment/">Node assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_maintenance/">Node maintenance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_overcommit/">Node overcommit</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/unresponsive_nodes/">Unresponsive nodes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/containerized_data_importer/">Containerized Data Importer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/activating_feature_gates/">Activating feature gates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/mediated_devices_configuration/">Mediated devices and virtual GPUs</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Virtual machines</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../virtual_machine_instances/">Virtual Machines Instances</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lifecycle/">Lifecycle</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../run_strategies/">Run Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../presets/">Presets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../virtual_hardware/">Virtual hardware</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dedicated_cpu_resources/">Dedicated CPU resources</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../numa/">NUMA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../disks_and_volumes/">Disks and Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../interfaces_and_networks/">Interfaces and Networks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../istio_service_mesh/">Istio service mesh</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../networkpolicy/">NetworkPolicy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../host-devices/">Host Devices Assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../windows_virtio_drivers/">Windows virtio drivers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guest_operating_system_information/">Guest Operating System Information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guest_agent_information/">Guest Agent information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../liveness_and_readiness_probes/">Liveness and Readiness Probes</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Accessing Virtual Machines</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#graphical-and-serial-console-access">Graphical and Serial Console Access</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ssh-access">SSH Access</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../startup_scripts/">Startup Scripts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../service_objects/">Service objects</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../templates/">Templates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tekton_tasks/">KubeVirt Tekton</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../replicaset/">VirtualMachineInstanceReplicaSet</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dns/">DNS records</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../boot_from_external_source/">Booting From External Source</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../confidential_computing/">Confidential computing</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../web_console/">Web Console</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/contributing/">Contributing</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">KubeVirt User-Guide</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Virtual machines &raquo;</li>
      <li>Accessing Virtual Machines</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/kubevirt/user-guide/edit/main/docs/virtual_machines/accessing_virtual_machines.md"
          class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="accessing-virtual-machines">Accessing Virtual Machines<a class="headerlink" href="#accessing-virtual-machines" title="Permanent link">&para;</a></h1>
<h2 id="graphical-and-serial-console-access">Graphical and Serial Console Access<a class="headerlink" href="#graphical-and-serial-console-access" title="Permanent link">&para;</a></h2>
<p>Once a virtual machine is started you are able to connect to the
consoles it exposes. Usually there are two types of consoles:</p>
<ul>
<li>Serial Console</li>
<li>Graphical Console (VNC)</li>
</ul>
<blockquote>
<p>Note: You need to have <code>virtctl</code>
<a href="../../operations/virtctl_client_tool/">installed</a> to gain
access to the VirtualMachineInstance.</p>
</blockquote>
<h3 id="accessing-the-serial-console">Accessing the serial console<a class="headerlink" href="#accessing-the-serial-console" title="Permanent link">&para;</a></h3>
<p>The serial console of a virtual machine can be accessed by using the
<code>console</code> command:</p>
<pre><code>$ virtctl console --kubeconfig=$KUBECONFIG testvmi
</code></pre>
<h3 id="accessing-the-graphical-console-vnc">Accessing the graphical console (VNC)<a class="headerlink" href="#accessing-the-graphical-console-vnc" title="Permanent link">&para;</a></h3>
<p>Accessing the graphical console of a virtual machine is usually done
through VNC, which requires <code>remote-viewer</code>. Once the tool is installed
you can access the graphical console using:</p>
<pre><code>$ virtctl vnc --kubeconfig=$KUBECONFIG testvmi
</code></pre>
<p>If you need to open only a vnc-proxy without executing the <code>remote-viewer</code> command, it can be done using:</p>
<pre><code>$ virtctl vnc --kubeconfig=$KUBECONFIG --proxy-only testvmi
</code></pre>
<p>this would print the port number on your machine where you can manually connect using any of the vnc viewers</p>
<h3 id="debugging-console-access">Debugging console access<a class="headerlink" href="#debugging-console-access" title="Permanent link">&para;</a></h3>
<p>Should the connection fail, you can use the <code>-v</code> flag to get more output
from both <code>virtctl</code> and the <code>remote-viewer</code> tool, to troubleshoot the
problem.</p>
<pre><code>$ virtctl vnc --kubeconfig=$KUBECONFIG testvmi -v 4
</code></pre>
<blockquote>
<p><strong>Note:</strong> If you are using virtctl via ssh on a remote machine, you
need to forward the X session to your machine (Look up the -X and -Y
flags of <code>ssh</code> if you are not familiar with that). As an alternative
you can proxy the apiserver port with ssh to your machine (either
direct or in combination with <code>kubectl proxy</code>)</p>
</blockquote>
<h3 id="rbac-permissions-for-consolevnc-access">RBAC Permissions for Console/VNC Access<a class="headerlink" href="#rbac-permissions-for-consolevnc-access" title="Permanent link">&para;</a></h3>
<h4 id="using-default-rbac-clusterroles">Using Default RBAC ClusterRoles<a class="headerlink" href="#using-default-rbac-clusterroles" title="Permanent link">&para;</a></h4>
<p>Every KubeVirt installation after version v0.5.1 comes a set of default
RBAC cluster roles that can be used to grant users access to
VirtualMachineInstances.</p>
<p>The <strong>kubevirt.io:admin</strong> and <strong>kubevirt.io:edit</strong> ClusterRoles have
console and VNC access permissions built into them. By binding either of
these roles to a user, they will have the ability to use virtctl to
access console and VNC.</p>
<h4 id="with-custom-rbac-clusterrole">With Custom RBAC ClusterRole<a class="headerlink" href="#with-custom-rbac-clusterrole" title="Permanent link">&para;</a></h4>
<p>The default KubeVirt ClusterRoles give access to more than just console
in VNC. In the event that an Admin would like to craft a custom role
that targets only console and VNC, the ClusterRole below demonstrates
how that can be done.</p>
<pre><code>apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: allow-vnc-console-access
rules:
  - apiGroups:
      - subresources.kubevirt.io
    resources:
      - virtualmachineinstances/console
      - virtualmachineinstances/vnc
    verbs:
      - get
</code></pre>
<p>The ClusterRole above provides access to virtual machines across all
namespaces.</p>
<p>In order to reduce the scope to a single namespace, bind this
ClusterRole using a RoleBinding that targets a single namespace.</p>
<h2 id="ssh-access">SSH Access<a class="headerlink" href="#ssh-access" title="Permanent link">&para;</a></h2>
<p>A common operational pattern used when managing virtual machines is to inject
public ssh keys into the virtual machines at boot. This allows automation tools
(like ansible) to provision the virtual machine. It also gives operators a way
of gaining secure passwordless access to a virtual machine.</p>
<p>KubeVirt provides multiple ways to inject ssh public keys into a virtual
machine. In general, these methods fall into two categories. <a href="./#static-ssh-key-injection-via-cloud-init">Static key injection</a>,
 which places keys on the virtual machine the first time it is
booted, and <a href="./#dynamic-ssh-key-injection-via-qemu-user-agent">dynamic injection</a>, which allows keys to be dynamically updated
both at boot and during runtime.</p>
<h3 id="static-ssh-key-injection-via-cloud-init">Static SSH Key Injection via Cloud Init<a class="headerlink" href="#static-ssh-key-injection-via-cloud-init" title="Permanent link">&para;</a></h3>
<p>Users creating virtual machines have the ability to provide startup scripts to
their virtual machines which allow any number of custom operations to take place.
Placing public ssh keys into a <a href="../startup_scripts/#cloud-init">cloud-init startup script</a> is one option people
have for getting their public keys into the virtual machine, however there are
some other options that grant more flexibility.</p>
<p>The VM's access credential api allows statically injecting ssh public keys at creation
time independently of the cloud-init user data by placing the ssh public key
in a Kubernetes secret. This is useful because it allows people creating virtual
machines to separate the application data in their cloud-init user data from the
credentials used to access the virtual machine.</p>
<p>For example, someone can put their ssh key into a Kubernetes secret like this.</p>
<pre><code># Place ssh key into a secret

kubectl create secret generic my-pub-key --from-file=key1=/id_rsa.pub
</code></pre>
<p>Then assign that key to the virtual machine with the access credentials api
using the configDrive propagation method. Note here how the cloud-init user
data is not touched. KubeVirt is injecting the ssh key into the virtual machine
using the machine generated cloud-init metadata, and not the user data. This
keeps the application user date separate from credentials.</p>
<pre><code>#Create a vm yaml that references the secret in using the access credentials api.


cat &lt;&lt; END &gt; my-vm.yaml
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  labels:
    kubevirt.io/vm: my-vm
  name: my-vm
spec:
  dataVolumeTemplates:
  - metadata:
      creationTimestamp: null
      name: fedora-dv
    spec:
      pvc:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 5Gi
        storageClassName: local
      source:
        registry:
          url: docker://quay.io/kubevirt/fedora-cloud-container-disk-demo
  running: false
  template:
    metadata:
      labels:
        kubevirt.io/vm: my-vm
    spec:
      domain:
        devices:
          disks:
          - disk:
              bus: virtio
            name: disk0
          - disk:
              bus: virtio
            name: disk1
        machine:
          type: &quot;&quot;
        resources:
          requests:
            cpu: 1000m
            memory: 1G
      terminationGracePeriodSeconds: 0
      accessCredentials:
      - sshPublicKey:
          source:
            secret:
              secretName: my-pub-key
          propagationMethod:
            configDrive: {}
      volumes:
      - dataVolume:
          name: fedora-dv
        name: disk0
      - cloudInitConfigDrive:
          userData: |
            #!/bin/bash
            echo &quot;Application setup goes here&quot;
        name: disk1
END

kubectl create -f my-vm.yaml

</code></pre>
<h3 id="dynamic-ssh-key-injection-via-qemu-user-agent">Dynamic SSH Key Injection via Qemu User Agent<a class="headerlink" href="#dynamic-ssh-key-injection-via-qemu-user-agent" title="Permanent link">&para;</a></h3>
<p>KubeVirt supports dynamically injecting public ssh keys at run time through the
use of the qemu guest agent. This is achieved through the access credentials
api by using the qemuGuestAgent propagation method.</p>
<blockquote>
<p>Note: This requires the qemu guest agent to be installed within the guest</p>
<p>Note: When using qemuGuestAgent propagation, the <code>/home/$USER/.ssh/authorized_keys</code>
file will be owned by the guest agent. Changes to that file that are made
outside of the qemu guest agent's control will get deleted.</p>
<p>Note: More information about the motivation behind the access credentials
api can be found in the <a href="https://github.com/kubevirt/kubevirt/pull/4195">pull request description</a> that introduced this api.</p>
</blockquote>
<p>In the example below, a secret contains an ssh key. When attached to the
VM via the access credential api with the qemuGuestAgent propagation method,
the contents of the secret can be updated at any time which will automatically
get applied to a running VM. The secret can contain multiple public keys.</p>
<pre><code># Place ssh key into a secret

kubectl create secret generic my-pub-key --from-file=key1=/id_rsa.pub
</code></pre>
<p>Now reference this secret on the VM with the access credentials api using
qemuGuestAgent propagation. This example installs and starts the qemu guest
agent using a cloud-init script in order to ensure the agent is available.</p>
<pre><code># Create a vm yaml that references the secret in using the access credentials api.


cat &lt;&lt; END &gt; my-vm.yaml
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  labels:
    kubevirt.io/vm: my-vm
  name: my-vm
spec:
  dataVolumeTemplates:
  - metadata:
      creationTimestamp: null
      name: fedora-dv
    spec:
      pvc:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 5Gi
        storageClassName: local
      source:
        registry:
          url: docker://quay.io/kubevirt/fedora-cloud-container-disk-demo
  running: false
  template:
    metadata:
      labels:
        kubevirt.io/vm: my-vm
    spec:
      domain:
        devices:
          disks:
          - disk:
              bus: virtio
            name: disk0
          - disk:
              bus: virtio
            name: disk1
        machine:
          type: &quot;&quot;
        resources:
          requests:
            cpu: 1000m
            memory: 1G
      terminationGracePeriodSeconds: 0
      accessCredentials:
      - sshPublicKey:
          source:
            secret:
              secretName: my-pub-key
          propagationMethod:
            qemuGuestAgent:
              users:
              - &quot;fedora&quot;
      volumes:
      - dataVolume:
          name: fedora-dv
        name: disk0
      - cloudInitConfigDrive:
          userData: |
            #!/bin/bash

            sudo setenforce Permissive
            sudo yum install -y qemu-guest-agent
            sudo systemctl start qemu-guest-agent
        name: disk1
END

kubectl create -f my-vm.yaml

</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../liveness_and_readiness_probes/" class="btn btn-neutral float-left" title="Liveness and Readiness Probes"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../startup_scripts/" class="btn btn-neutral float-right" title="Startup Scripts">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/kubevirt/user-guide/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../liveness_and_readiness_probes/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../startup_scripts/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

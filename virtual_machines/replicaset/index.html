<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://kubevirt.io/user-guide/virtual_machines/replicaset/" />
      <link rel="shortcut icon" href="../../assets/favicon.ico" />
    <title>VirtualMachineInstanceReplicaSet - KubeVirt User-Guide</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "VirtualMachineInstanceReplicaSet";
        var mkdocs_page_input_path = "virtual_machines/replicaset.md";
        var mkdocs_page_url = "/user-guide/virtual_machines/replicaset/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> KubeVirt User-Guide
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Welcome</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../release_notes/">KubeVirt release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Operations</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/updating_and_deletion/">Updating and deletion</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/basic_use/">Basic use</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/customize_components/">Customize components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/api_validation/">API Validation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/debug/">Debug</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/virtctl_client_tool/">virtctl Client Tool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/live_migration/">Live Migration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/hotplug_volumes/">Hotplug Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/snapshot_restore_api/">Snapshot Restore API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/hugepages/">Hugepages support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/component_monitoring/">Component monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/authorization/">Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/annotations_and_labels/">Annotations and labels</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_assignment/">Node assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_maintenance/">Node maintenance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_overcommit/">Node overcommit</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/unresponsive_nodes/">Unresponsive nodes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/containerized_data_importer/">Containerized Data Importer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/activating_feature_gates/">Activating feature gates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/export_api/">Export API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/clone_api/">Clone API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/memory_dump/">Virtual machine memory dump</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/mediated_devices_configuration/">Mediated devices and virtual GPUs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/migration_policies/">Migration Policies</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Virtual machines</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../virtual_machine_instances/">Virtual Machines Instances</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lifecycle/">Lifecycle</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../run_strategies/">Run Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../instancetypes/">Instancetypes and preferences</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../presets/">Presets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../virtual_hardware/">Virtual hardware</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dedicated_cpu_resources/">Dedicated CPU resources</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../numa/">NUMA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../disks_and_volumes/">Disks and Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../interfaces_and_networks/">Interfaces and Networks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../istio_service_mesh/">Istio service mesh</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../networkpolicy/">NetworkPolicy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../host-devices/">Host Devices Assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../windows_virtio_drivers/">Windows virtio drivers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guest_operating_system_information/">Guest Operating System Information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guest_agent_information/">Guest Agent information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../liveness_and_readiness_probes/">Liveness and Readiness Probes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../accessing_virtual_machines/">Accessing Virtual Machines</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../startup_scripts/">Startup Scripts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../service_objects/">Service objects</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../templates/">Templates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tekton_tasks/">KubeVirt Tekton</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">VirtualMachineInstanceReplicaSet</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#using-virtualmachineinstancereplicaset">Using VirtualMachineInstanceReplicaSet</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#exposing-a-virtualmachineinstancereplicaset-as-a-service">Exposing a VirtualMachineInstanceReplicaSet as a Service</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#when-to-use-a-virtualmachineinstancereplicaset">When to use a VirtualMachineInstanceReplicaSet</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dns/">DNS records</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../boot_from_external_source/">Booting From External Source</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../confidential_computing/">Confidential computing</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../web_console/">Web Console</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/contributing/">Contributing</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">KubeVirt User-Guide</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Virtual machines &raquo;</li>
      <li>VirtualMachineInstanceReplicaSet</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/kubevirt/user-guide/edit/main/docs/virtual_machines/replicaset.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="virtualmachineinstancereplicaset">VirtualMachineInstanceReplicaSet<a class="headerlink" href="#virtualmachineinstancereplicaset" title="Permanent link">&para;</a></h1>
<p>A <em>VirtualMachineInstanceReplicaSet</em> tries to ensures that a specified
number of VirtualMachineInstance replicas are running at any time. In
other words, a <em>VirtualMachineInstanceReplicaSet</em> makes sure that a
VirtualMachineInstance or a homogeneous set of VirtualMachineInstances
is always up and ready. It is very similar to a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/">Kubernetes
ReplicaSet</a>.</p>
<p>No state is kept and no guarantees about the maximum number of
VirtualMachineInstance replicas which are up are given. For example, the
<em>VirtualMachineInstanceReplicaSet</em> may decide to create new replicas if
possibly still running VMs are entering an unknown state.</p>
<h2 id="using-virtualmachineinstancereplicaset">Using VirtualMachineInstanceReplicaSet<a class="headerlink" href="#using-virtualmachineinstancereplicaset" title="Permanent link">&para;</a></h2>
<p>The <em>VirtualMachineInstanceReplicaSet</em> allows us to specify a
<em>VirtualMachineInstanceTemplate</em> in <code>spec.template</code>. It consists of
<code>ObjectMetadata</code> in <code>spec.template.metadata</code>, and a
<code>VirtualMachineInstanceSpec</code> in <code>spec.template.spec</code>. The specification
of the virtual machine is equal to the specification of the virtual
machine in the <code>VirtualMachineInstance</code> workload.</p>
<p><code>spec.replicas</code> can be used to specify how many replicas are wanted. If
unspecified, the default value is 1. This value can be updated anytime.
The controller will react to the changes.</p>
<p><code>spec.selector</code> is used by the controller to keep track of managed
virtual machines. The selector specified there must be able to match the
virtual machine labels as specified in <code>spec.template.metadata.labels</code>.
If the selector does not match these labels, or they are empty, the
controller will simply do nothing except from logging an error. The user
is responsible for not creating other virtual machines or
<em>VirtualMachineInstanceReplicaSets</em> which conflict with the selector and
the template labels.</p>
<h2 id="exposing-a-virtualmachineinstancereplicaset-as-a-service">Exposing a VirtualMachineInstanceReplicaSet as a Service<a class="headerlink" href="#exposing-a-virtualmachineinstancereplicaset-as-a-service" title="Permanent link">&para;</a></h2>
<p>A VirtualMachineInstanceReplicaSet could be exposed as a service. When
this is done, one of the VirtualMachineInstances replicas will be picked
for the actual delivery of the service.</p>
<p>For example, exposing SSH port (22) as a ClusterIP service using virtctl
on a VirtualMachineInstanceReplicaSet:</p>
<pre><code>$ virtctl expose vmirs vmi-ephemeral --name vmiservice --port 27017 --target-port 22
</code></pre>
<p>All service exposure options that apply to a VirtualMachineInstance
apply to a VirtualMachineInstanceReplicaSet. See <a href="http://kubevirt.io/user-guide/#/workloads/virtual-machines/expose-service">Exposing
VirtualMachineInstance</a>
for more details.</p>
<h2 id="when-to-use-a-virtualmachineinstancereplicaset">When to use a VirtualMachineInstanceReplicaSet<a class="headerlink" href="#when-to-use-a-virtualmachineinstancereplicaset" title="Permanent link">&para;</a></h2>
<blockquote>
<p><strong>Note:</strong> The base assumption is that referenced disks are read-only
or that the VMIs are writing internally to a tmpfs. The most obvious
volume sources for VirtualMachineInstanceReplicaSets which KubeVirt
supports are referenced below. If other types are used <strong>data
corruption</strong> is possible.</p>
</blockquote>
<p>Using VirtualMachineInstanceReplicaSet is the right choice when one
wants many identical VMs and does not care about maintaining any disk
state after the VMs are terminated.</p>
<p><a href="../disks_and_volumes/">Volume types</a> which
work well in combination with a VirtualMachineInstanceReplicaSet are:</p>
<ul>
<li><strong>cloudInitNoCloud</strong></li>
<li><strong>ephemeral</strong></li>
<li><strong>containerDisk</strong></li>
<li><strong>emptyDisk</strong></li>
<li><strong>configMap</strong></li>
<li><strong>secret</strong></li>
<li>any other type, if the VMI writes internally to a tmpfs</li>
</ul>
<h3 id="fast-starting-ephemeral-virtual-machines">Fast starting ephemeral Virtual Machines<a class="headerlink" href="#fast-starting-ephemeral-virtual-machines" title="Permanent link">&para;</a></h3>
<p>This use-case involves small and fast booting VMs with little
provisioning performed during initialization.</p>
<p>In this scenario, migrations are not important. Redistributing VM
workloads between Nodes can be achieved simply by deleting managed
VirtualMachineInstances which are running on an overloaded Node. The
<code>eviction</code> of such a VirtualMachineInstance can happen by directly
deleting the VirtualMachineInstance instance (KubeVirt aware workload
redistribution) or by deleting the corresponding Pod where the Virtual
Machine runs in (Only Kubernetes aware workload redistribution).</p>
<h3 id="slow-starting-ephemeral-virtual-machines">Slow starting ephemeral Virtual Machines<a class="headerlink" href="#slow-starting-ephemeral-virtual-machines" title="Permanent link">&para;</a></h3>
<p>In this use-case one has big and slow booting VMs, and complex or
resource intensive provisioning is done during boot. More specifically,
the timespan between the creation of a new VM and it entering the ready
state is long.</p>
<p>In this scenario, one still does not care about the state, but since
re-provisioning VMs is expensive, migrations are important. Workload
redistribution between Nodes can be achieved by migrating
VirtualMachineInstances to different Nodes. A workload redistributor
needs to be aware of KubeVirt and create migrations, instead of
<code>evicting</code> VirtualMachineInstances by deletion.</p>
<blockquote>
<p><strong>Note:</strong> The simplest form of having a migratable ephemeral
VirtualMachineInstance, will be to use local storage based on
<code>ContainerDisks</code> in combination with a file based backing store.
However, migratable backing store support has not officially landed
yet in KubeVirt and is untested.</p>
</blockquote>
<h4 id="example">Example<a class="headerlink" href="#example" title="Permanent link">&para;</a></h4>
<pre><code>apiVersion: kubevirt.io/v1
kind: VirtualMachineInstanceReplicaSet
metadata:
  name: testreplicaset
spec:
  replicas: 3
  selector:
    matchLabels:
      myvmi: myvmi
  template:
    metadata:
      name: test
      labels:
        myvmi: myvmi
    spec:
      domain:
        devices:
          disks:
          - disk:
            name: containerdisk
        resources:
          requests:
            memory: 64M
      volumes:
      - name: containerdisk
        containerDisk:
          image: kubevirt/cirros-container-disk-demo:latest
</code></pre>
<p>Saving this manifest into <code>testreplicaset.yaml</code> and submitting it to
Kubernetes will create three virtual machines based on the template.</p>
<pre><code>$ kubectl create -f testreplicaset.yaml
virtualmachineinstancereplicaset "testreplicaset" created
$ kubectl describe vmirs testreplicaset
Name:         testreplicaset
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
API Version:  kubevirt.io/v1
Kind:         VirtualMachineInstanceReplicaSet
Metadata:
  Cluster Name:
  Creation Timestamp:  2018-01-03T12:42:30Z
  Generation:          0
  Resource Version:    6380
  Self Link:           /apis/kubevirt.io/v1/namespaces/default/virtualmachineinstancereplicasets/testreplicaset
  UID:                 903a9ea0-f083-11e7-9094-525400ee45b0
Spec:
  Replicas:  3
  Selector:
    Match Labels:
      Myvmi:  myvmi
  Template:
    Metadata:
      Creation Timestamp:  &lt;nil&gt;
      Labels:
        Myvmi:  myvmi
      Name:    test
    Spec:
      Domain:
        Devices:
          Disks:
            Disk:
            Name:         containerdisk
            Volume Name:  containerdisk
        Resources:
          Requests:
            Memory:  64M
      Volumes:
        Name:  containerdisk
        Container Disk:
          Image:  kubevirt/cirros-container-disk-demo:latest
Status:
  Conditions:      &lt;nil&gt;
  Ready Replicas:  2
  Replicas:        3
Events:
  Type    Reason            Age   From                                 Message
  ----    ------            ----  ----                                 -------
  Normal  SuccessfulCreate  13s   virtualmachineinstancereplicaset-controller  Created virtual machine: testh8998
  Normal  SuccessfulCreate  13s   virtualmachineinstancereplicaset-controller  Created virtual machine: testf474w
  Normal  SuccessfulCreate  13s   virtualmachineinstancereplicaset-controller  Created virtual machine: test5lvkd
</code></pre>
<p><code>Replicas</code> is <code>3</code> and <code>Ready Replicas</code> is <code>2</code>. This means that at the
moment when showing the status, three Virtual Machines were already
created, but only two are running and ready.</p>
<h3 id="scaling-via-the-scale-subresource">Scaling via the Scale Subresource<a class="headerlink" href="#scaling-via-the-scale-subresource" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>Note:</strong> This requires the <code>CustomResourceSubresources</code>
<a href="../../operations/activating_feature_gates/#how-to-activate-a-feature-gate">feature gate</a>
to be enabled for clusters prior to 1.11.</p>
</blockquote>
<p>The <code>VirtualMachineInstanceReplicaSet</code> supports the <code>scale</code> subresource.
As a consequence it is possible to scale it via <code>kubectl</code>:</p>
<pre><code>$ kubectl scale vmirs myvmirs --replicas 5
</code></pre>
<h3 id="using-the-horizontal-pod-autoscaler">Using the Horizontal Pod Autoscaler<a class="headerlink" href="#using-the-horizontal-pod-autoscaler" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>Note:</strong> This requires at cluster newer or equal to 1.11.</p>
</blockquote>
<p>The
<a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">HorizontalPodAutoscaler</a>
(HPA) can be used with a <code>VirtualMachineInstanceReplicaSet</code>. Simply
reference it in the spec of the autoscaler:</p>
<pre><code>apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: myhpa
spec:
  scaleTargetRef:
    kind: VirtualMachineInstanceReplicaSet
    name: vmi-replicaset-cirros
    apiVersion: kubevirt.io/v1
  minReplicas: 3
  maxReplicas: 10
  targetCPUUtilizationPercentage: 50
</code></pre>
<p>or use <code>kubectl autoscale</code> to define the HPA via the commandline:</p>
<pre><code>$ kubectl autoscale vmirs vmi-replicaset-cirros --min=3 --max=10
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../tekton_tasks/" class="btn btn-neutral float-left" title="KubeVirt Tekton"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../dns/" class="btn btn-neutral float-right" title="DNS records">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/kubevirt/user-guide/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../tekton_tasks/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../dns/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

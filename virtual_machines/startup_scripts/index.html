<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://kubevirt.io/user-guide/virtual_machines/startup_scripts/" />
      <link rel="shortcut icon" href="../../assets/favicon.ico" />
    <title>Startup Scripts - KubeVirt User-Guide</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Startup Scripts";
        var mkdocs_page_input_path = "virtual_machines/startup_scripts.md";
        var mkdocs_page_url = "/user-guide/virtual_machines/startup_scripts/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> KubeVirt User-Guide
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Welcome</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../release_notes/">KubeVirt release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Operations</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/updating_and_deletion/">Updating and deletion</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/basic_use/">Basic use</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/api_validation/">API Validation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/debug/">Debug</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/virtctl_client_tool/">virtctl Client Tool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/live_migration/">Live Migration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/hotplug_volumes/">Hotplug Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/snapshot_restore_api/">Snapshot Restore API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/hugepages/">Hugepages support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/component_monitoring/">Component monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/authorization/">Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/annotations_and_labels/">Annotations and labels</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_assignment/">Node assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_maintenance/">Node maintenance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_overcommit/">Node overcommit</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/unresponsive_nodes/">Unresponsive nodes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/containerized_data_importer/">Containerized Data Importer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/activating_feature_gates/">Activating feature gates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/mediated_devices_configuration/">Mediated devices and virtual GPUs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/migration_policies/">Migration Policies</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Virtual machines</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../virtual_machine_instances/">Virtual Machines Instances</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lifecycle/">Lifecycle</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../run_strategies/">Run Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../instancetypes/">Instancetypes and preferences</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../presets/">Presets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../virtual_hardware/">Virtual hardware</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dedicated_cpu_resources/">Dedicated CPU resources</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../numa/">NUMA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../disks_and_volumes/">Disks and Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../interfaces_and_networks/">Interfaces and Networks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../istio_service_mesh/">Istio service mesh</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../networkpolicy/">NetworkPolicy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../host-devices/">Host Devices Assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../windows_virtio_drivers/">Windows virtio drivers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guest_operating_system_information/">Guest Operating System Information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guest_agent_information/">Guest Agent information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../liveness_and_readiness_probes/">Liveness and Readiness Probes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../accessing_virtual_machines/">Accessing Virtual Machines</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Startup Scripts</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#cloud-init">Cloud-init</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sysprep">Sysprep</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cloud-init-examples">Cloud-init Examples</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sysprep-examples">Sysprep Examples</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../service_objects/">Service objects</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../templates/">Templates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tekton_tasks/">KubeVirt Tekton</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../replicaset/">VirtualMachineInstanceReplicaSet</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dns/">DNS records</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../boot_from_external_source/">Booting From External Source</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../confidential_computing/">Confidential computing</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../web_console/">Web Console</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/contributing/">Contributing</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">KubeVirt User-Guide</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Virtual machines &raquo;</li>
      <li>Startup Scripts</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/kubevirt/user-guide/edit/main/docs/virtual_machines/startup_scripts.md"
          class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="startup-scripts">Startup Scripts<a class="headerlink" href="#startup-scripts" title="Permanent link">&para;</a></h1>
<p>KubeVirt supports the ability to assign a startup script to a
VirtualMachineInstance instance which is executed automatically when the
VM initializes.</p>
<p>These scripts are commonly used to automate injection of users and SSH
keys into VMs in order to provide remote access to the machine. For
example, a startup script can be used to inject credentials into a VM
that allows an Ansible job running on a remote host to access and
provision the VM.</p>
<p>Startup scripts are not limited to any specific use case though. They
can be used to run any arbitrary script in a VM on boot.</p>
<h2 id="cloud-init">Cloud-init<a class="headerlink" href="#cloud-init" title="Permanent link">&para;</a></h2>
<p>cloud-init is a widely adopted project used for early initialization of
a VM. Used by cloud providers such as AWS and GCP, cloud-init has
established itself as the defacto method of providing startup scripts to
VMs.</p>
<p>Cloud-init documentation can be found here: <a href="https://cloudinit.readthedocs.io/en/latest/">Cloud-init
Documentation</a>.</p>
<p>KubeVirt supports cloud-init's "NoCloud" and "ConfigDrive" datasources
which involve injecting startup scripts into a VM instance through the
use of an ephemeral disk. VMs with the cloud-init package installed will
detect the ephemeral disk and execute custom userdata scripts at boot.</p>
<h2 id="sysprep">Sysprep<a class="headerlink" href="#sysprep" title="Permanent link">&para;</a></h2>
<p>Sysprep is an automation tool for Windows that automates Windows
installation, setup, and custom software provisioning.</p>
<p>The general flow is:</p>
<ol>
<li>
<p>Seal the vm image with the Sysprep tool, for example by running:</p>
<pre><code>%WINDIR%\system32\sysprep\sysprep.exe /generalize /shutdown /oobe /mode:vm
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We need to make sure the base vm does not restart, which can be done by setting the vm run strategy as <code>RerunOnFailure</code>.</p>
<p>VM runStrategy:</p>
<pre><code>spec:
  runStrategy: RerunOnFailure
</code></pre>
</div>
<p>More information can be found here:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/sysprep-process-overview">Sysprep Process Overview</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/sysprep--generalize--a-windows-installation">Sysprep (Generalize) a Windows installation</a></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is important that there is no answer file detected when the Sysprep Tool is triggered, because Windows Setup searches for answer files at the beginning of each configuration pass and caches it. If that happens, when the OS will start - it will just use the cached answer file, ignoring the one we provide through the Sysprep API. More information can be found <a href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/windows-setup-automation-overview#implicit-answer-file-search-order">here</a>.</p>
</div>
</li>
<li>
<p>Providing an Answer file named <code>autounattend.xml</code> in an attached media. The answer file can be provided in a ConfigMap or a Secret with the key <code>autounattend.xml</code></p>
<p>The configuration file can be generated with <a href="https://docs.microsoft.com/en-us/windows-hardware/customize/desktop/wsim/windows-system-image-manager-overview-topics">Windows SIM</a> or it can be specified manually according to the information found here:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/update-windows-settings-and-scripts-create-your-own-answer-file-sxs">Answer files (unattend.xml)</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows-hardware/customize/desktop/wsim/answer-files-overview">Answer File Reference</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows-hardware/customize/desktop/unattend/components-b-unattend">Answer File Components Reference</a></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are also many easy to find online tools available for creating an answer file.</p>
</div>
</li>
</ol>
<h2 id="cloud-init-examples">Cloud-init Examples<a class="headerlink" href="#cloud-init-examples" title="Permanent link">&para;</a></h2>
<h3 id="user-data">User Data<a class="headerlink" href="#user-data" title="Permanent link">&para;</a></h3>
<p>KubeVirt supports the cloud-init NoCloud and ConfigDrive data sources
which involve injecting startup scripts through the use of a disk
attached to the VM.</p>
<p>In order to assign a custom userdata script to a VirtualMachineInstance
using this method, users must define a disk and a volume for the NoCloud
or ConfigDrive datasource in the VirtualMachineInstance's spec.</p>
<h4 id="data-sources">Data Sources<a class="headerlink" href="#data-sources" title="Permanent link">&para;</a></h4>
<p>Under most circumstances users should stick to the NoCloud data source
as it is the simplest cloud-init data source. Only if NoCloud is not
supported by the cloud-init implementation (e.g.
<a href="https://github.com/coreos/coreos-cloudinit">coreos-cloudinit</a>) users
should switch the data source to ConfigDrive.</p>
<p>Switching the cloud-init data source to ConfigDrive is as easy as
changing the volume type in the VirtualMachineInstance's spec from
<code>cloudInitNoCloud</code> to <code>cloudInitConfigDrive</code>.</p>
<p>NoCloud data source:</p>
<pre><code>volumes:
  - name: cloudinitvolume
    cloudInitNoCloud:
      userData: "#cloud-config"
</code></pre>
<p>ConfigDrive data source:</p>
<pre><code>volumes:
  - name: cloudinitvolume
    cloudInitConfigDrive:
      userData: "#cloud-config"
</code></pre>
<p>See the examples below for more complete cloud-init examples.</p>
<h4 id="cloud-init-user-data-as-clear-text">Cloud-init user-data as clear text<a class="headerlink" href="#cloud-init-user-data-as-clear-text" title="Permanent link">&para;</a></h4>
<p>In the example below, a SSH key is stored in the cloudInitNoCloud
Volume's userData field as clean text. There is a corresponding disks
entry that references the cloud-init volume and assigns it to the VM's
device.</p>
<pre><code># Create a VM manifest with the startup script
# a cloudInitNoCloud volume's userData field.

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        disk:
          bus: virtio
      - name: cloudinitdisk
        disk:
          bus: virtio
  volumes:
    - name: containerdisk
      containerDisk:
        image: kubevirt/cirros-container-disk-demo:latest
    - name: cloudinitdisk
      cloudInitNoCloud:
        userData: |
          #cloud-config
          ssh_authorized_keys:
            - ssh-rsa AAAAB3NzaK8L93bWxnyp test@test.com

END

# Post the Virtual Machine spec to KubeVirt.

kubectl create -f my-vmi.yaml
</code></pre>
<h4 id="cloud-init-user-data-as-base64-string">Cloud-init user-data as base64 string<a class="headerlink" href="#cloud-init-user-data-as-base64-string" title="Permanent link">&para;</a></h4>
<p>In the example below, a simple bash script is base64 encoded and stored
in the cloudInitNoCloud Volume's userDataBase64 field. There is a
corresponding disks entry that references the cloud-init volume and
assigns it to the VM's device.</p>
<p><em>Users also have the option of storing the startup script in a
Kubernetes Secret and referencing the Secret in the VM's spec. Examples
further down in the document illustrate how that is done.</em></p>
<pre><code># Create a simple startup script

cat &lt;&lt; END &gt; startup-script.sh
#!/bin/bash
echo "Hi from startup script!"
END

# Create a VM manifest with the startup script base64 encoded into
# a cloudInitNoCloud volume's userDataBase64 field.

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        disk:
          bus: virtio
      - name: cloudinitdisk
        disk:
          bus: virtio
  volumes:
    - name: containerdisk
      containerDisk:
        image: kubevirt/cirros-container-disk-demo:latest
    - name: cloudinitdisk
      cloudInitNoCloud:
        userDataBase64: $(cat startup-script.sh | base64 -w0)
END

# Post the Virtual Machine spec to KubeVirt.

kubectl create -f my-vmi.yaml
</code></pre>
<h4 id="cloud-init-userdata-as-k8s-secret">Cloud-init UserData as k8s Secret<a class="headerlink" href="#cloud-init-userdata-as-k8s-secret" title="Permanent link">&para;</a></h4>
<p>Users who wish to not store the cloud-init userdata directly in the
VirtualMachineInstance spec have the option to store the userdata into a
Kubernetes Secret and reference that Secret in the spec.</p>
<p>Multiple VirtualMachineInstance specs can reference the same Kubernetes
Secret containing cloud-init userdata.</p>
<p>Below is an example of how to create a Kubernetes Secret containing a
startup script and reference that Secret in the VM's spec.</p>
<pre><code># Create a simple startup script

cat &lt;&lt; END &gt; startup-script.sh
#!/bin/bash
echo "Hi from startup script!"
END

# Store the startup script in a Kubernetes Secret
kubectl create secret generic my-vmi-secret --from-file=userdata=startup-script.sh

# Create a VM manifest and reference the Secret's name in the cloudInitNoCloud
# Volume's secretRef field

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        disk:
          bus: virtio
      - name: cloudinitdisk
        disk:
          bus: virtio
  volumes:
    - name: containerdisk
      containerDisk:
        image: kubevirt/cirros-registry-disk-demo:latest
    - name: cloudinitdisk
      cloudInitNoCloud:
        secretRef:
          name: my-vmi-secret
END

# Post the VM
kubectl create -f my-vmi.yaml
</code></pre>
<h4 id="injecting-ssh-keys-with-cloud-inits-cloud-config">Injecting SSH keys with Cloud-init's Cloud-config<a class="headerlink" href="#injecting-ssh-keys-with-cloud-inits-cloud-config" title="Permanent link">&para;</a></h4>
<p>In the examples so far, the cloud-init userdata script has been a bash
script. Cloud-init has it's own configuration that can handle some
common tasks such as user creation and SSH key injection.</p>
<p>More cloud-config examples can be found here: <a href="https://cloudinit.readthedocs.io/en/latest/topics/examples.html">Cloud-init
Examples</a></p>
<!-- markdown-link-check-disable -->
<p>Below is an example of using cloud-config to inject an SSH key for the
default user (fedora in this case) of a <a href="https://www.projectatomic.io/">Fedora Atomic</a> disk image.</p>
<!-- markdown-link-check-enable -->

<pre><code># Create the cloud-init cloud-config userdata.
cat &lt;&lt; END &gt; startup-script
#cloud-config
password: atomic
chpasswd: { expire: False }
ssh_pwauth: False
ssh_authorized_keys:
    - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6zdgFiLr1uAK7PdcchDd+LseA5fEOcxCCt7TLlr7Mx6h8jUg+G+8L9JBNZuDzTZSF0dR7qwzdBBQjorAnZTmY3BhsKcFr8Gt4KMGrS6r3DNmGruP8GORvegdWZuXgASKVpXeI7nCIjRJwAaK1x+eGHwAWO9Z8ohcboHbLyffOoSZDSIuk2kRIc47+ENRjg0T6x2VRsqX27g6j4DfPKQZGk0zvXkZaYtr1e2tZgqTBWqZUloMJK8miQq6MktCKAS4VtPk0k7teQX57OGwD6D7uo4b+Cl8aYAAwhn0hc0C2USfbuVHgq88ESo2/+NwV4SQcl3sxCW21yGIjAGt4Hy7J fedora@localhost.localdomain
END

# Create the VM spec
cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachineInstance
metadata:
  name: sshvmi
spec:
  terminationGracePeriodSeconds: 0
  domain:
    resources:
      requests:
        memory: 1024M
    devices:
      disks:
      - name: containerdisk
        disk:
          dev: vda
      - name: cloudinitdisk
        disk:
          dev: vdb
  volumes:
    - name: containerdisk
      containerDisk:
        image: kubevirt/fedora-atomic-registry-disk-demo:latest
    - name: cloudinitdisk
      cloudInitNoCloud:
        userDataBase64: $(cat startup-script | base64 -w0)
END

# Post the VirtualMachineInstance spec to KubeVirt.
kubectl create -f my-vmi.yaml

# Connect to VM with passwordless SSH key
ssh -i &lt;insert private key here&gt; fedora@&lt;insert ip here&gt;
</code></pre>
<h4 id="inject-ssh-key-using-a-custom-shell-script">Inject SSH key using a Custom Shell Script<a class="headerlink" href="#inject-ssh-key-using-a-custom-shell-script" title="Permanent link">&para;</a></h4>
<p>Depending on the boot image in use, users may have a mixed experience
using cloud-init's cloud-config to create users and inject SSH keys.</p>
<p>Below is an example of creating a user and injecting SSH keys for that
user using a script instead of cloud-config.</p>
<pre><code>cat &lt;&lt; END &gt; startup-script.sh
#!/bin/bash
export NEW_USER="foo"
export SSH_PUB_KEY="ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6zdgFiLr1uAK7PdcchDd+LseA5fEOcxCCt7TLlr7Mx6h8jUg+G+8L9JBNZuDzTZSF0dR7qwzdBBQjorAnZTmY3BhsKcFr8Gt4KMGrS6r3DNmGruP8GORvegdWZuXgASKVpXeI7nCIjRJwAaK1x+eGHwAWO9Z8ohcboHbLyffOoSZDSIuk2kRIc47+ENRjg0T6x2VRsqX27g6j4DfPKQZGk0zvXkZaYtr1e2tZgqTBWqZUloMJK8miQq6MktCKAS4VtPk0k7teQX57OGwD6D7uo4b+Cl8aYAAwhn0hc0C2USfbuVHgq88ESo2/+NwV4SQcl3sxCW21yGIjAGt4Hy7J $NEW_USER@localhost.localdomain"

sudo adduser -U -m $NEW_USER
echo "$NEW_USER:atomic" | chpasswd
sudo mkdir /home/$NEW_USER/.ssh
sudo echo "$SSH_PUB_KEY" &gt; /home/$NEW_USER/.ssh/authorized_keys
sudo chown -R ${NEW_USER}: /home/$NEW_USER/.ssh
END

# Create the VM spec
cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachineInstance
metadata:
  name: sshvmi
spec:
  terminationGracePeriodSeconds: 0
  domain:
    resources:
      requests:
        memory: 1024M
    devices:
      disks:
      - name: containerdisk
        disk:
          dev: vda
      - name: cloudinitdisk
        disk:
          dev: vdb
  volumes:
    - name: containerdisk
      containerDisk:
        image: kubevirt/fedora-atomic-registry-disk-demo:latest
    - name: cloudinitdisk
      cloudInitNoCloud:
        userDataBase64: $(cat startup-script.sh | base64 -w0)
END

# Post the VirtualMachineInstance spec to KubeVirt.
kubectl create -f my-vmi.yaml

# Connect to VM with passwordless SSH key
ssh -i &lt;insert private key here&gt; foo@&lt;insert ip here&gt;
</code></pre>
<h3 id="network-config">Network Config<a class="headerlink" href="#network-config" title="Permanent link">&para;</a></h3>
<p>A cloud-init <a href="https://cloudinit.readthedocs.io/en/latest/topics/network-config-format-v1.html">network version
1</a>
configuration can be set to configure the network at boot.</p>
<p>Cloud-init <a href="#user-data">user-data</a> <strong>must</strong> be set for cloud-init to
parse <em>network-config</em> even if it is just the user-data config header:</p>
<pre><code>#cloud-config
</code></pre>
<h4 id="cloud-init-network-config-as-clear-text">Cloud-init network-config as clear text<a class="headerlink" href="#cloud-init-network-config-as-clear-text" title="Permanent link">&para;</a></h4>
<p>In the example below, a simple cloud-init network-config is stored in
the cloudInitNoCloud Volume's networkData field as clean text. There is
a corresponding disks entry that references the cloud-init volume and
assigns it to the VM's device.</p>
<pre><code># Create a VM manifest with the network-config in
# a cloudInitNoCloud volume's networkData field.

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha2
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        volumeName: registryvolume
        disk:
          bus: virtio
      - name: cloudinitdisk
        volumeName: cloudinitvolume
        disk:
          bus: virtio
  volumes:
    - name: registryvolume
      containerDisk:
        image: kubevirt/cirros-container-disk-demo:latest
    - name: cloudinitvolume
      cloudInitNoCloud:
        userData: "#cloud-config"
        networkData: |
          network:
            version: 1
            config:
            - type: physical
            name: eth0
            subnets:
              - type: dhcp

END

# Post the Virtual Machine spec to KubeVirt.

kubectl create -f my-vmi.yaml
</code></pre>
<h4 id="cloud-init-network-config-as-base64-string">Cloud-init network-config as base64 string<a class="headerlink" href="#cloud-init-network-config-as-base64-string" title="Permanent link">&para;</a></h4>
<p>In the example below, a simple network-config is base64 encoded and
stored in the cloudInitNoCloud Volume's networkDataBase64 field. There
is a corresponding disks entry that references the cloud-init volume and
assigns it to the VM's device.</p>
<p><em>Users also have the option of storing the network-config in a
Kubernetes Secret and referencing the Secret in the VM's spec. Examples
further down in the document illustrate how that is done.</em></p>
<pre><code># Create a simple network-config

cat &lt;&lt; END &gt; network-config
network:
  version: 1
  config:
  - type: physical
  name: eth0
  subnets:
    - type: dhcp
END

# Create a VM manifest with the networkData base64 encoded into
# a cloudInitNoCloud volume's networkDataBase64 field.

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha2
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        volumeName: registryvolume
        disk:
          bus: virtio
      - name: cloudinitdisk
        volumeName: cloudinitvolume
        disk:
          bus: virtio
  volumes:
    - name: registryvolume
      containerDisk:
        image: kubevirt/cirros-container-disk-demo:latest
    - name: cloudinitvolume
      cloudInitNoCloud:
        userData: "#cloud-config"
        networkDataBase64: $(cat network-config | base64 -w0)
END

# Post the Virtual Machine spec to KubeVirt.

kubectl create -f my-vmi.yaml
</code></pre>
<h4 id="cloud-init-network-config-as-k8s-secret">Cloud-init network-config as k8s Secret<a class="headerlink" href="#cloud-init-network-config-as-k8s-secret" title="Permanent link">&para;</a></h4>
<p>Users who wish to not store the cloud-init network-config directly in
the VirtualMachineInstance spec have the option to store the
network-config into a Kubernetes Secret and reference that Secret in the
spec.</p>
<p>Multiple VirtualMachineInstance specs can reference the same Kubernetes
Secret containing cloud-init network-config.</p>
<p>Below is an example of how to create a Kubernetes Secret containing a
network-config and reference that Secret in the VM's spec.</p>
<pre><code># Create a simple network-config

cat &lt;&lt; END &gt; network-config
network:
  version: 1
  config:
  - type: physical
  name: eth0
  subnets:
    - type: dhcp
END

# Store the network-config in a Kubernetes Secret
kubectl create secret generic my-vmi-secret --from-file=networkdata=network-config

# Create a VM manifest and reference the Secret's name in the cloudInitNoCloud
# Volume's secretRef field

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha2
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        volumeName: registryvolume
        disk:
          bus: virtio
      - name: cloudinitdisk
        volumeName: cloudinitvolume
        disk:
          bus: virtio
  volumes:
    - name: registryvolume
      containerDisk:
        image: kubevirt/cirros-registry-disk-demo:latest
    - name: cloudinitvolume
      cloudInitNoCloud:
        userData: "#cloud-config"
        networkDataSecretRef:
          name: my-vmi-secret
END

# Post the VM
kubectl create -f my-vmi.yaml
</code></pre>
<h3 id="debugging">Debugging<a class="headerlink" href="#debugging" title="Permanent link">&para;</a></h3>
<p>Depending on the operating system distribution in use, cloud-init output
is often printed to the console output on boot up. When developing
userdata scripts, users can connect to the VM's console during boot up
to debug.</p>
<p>Example of connecting to console using virtctl:</p>
<pre><code>virtctl console &lt;name of vmi&gt;
</code></pre>
<h3 id="device-role-tagging">Device Role Tagging<a class="headerlink" href="#device-role-tagging" title="Permanent link">&para;</a></h3>
<p>KubeVirt provides a mechanism for users to tag devices such as Network
Interfaces with a specific role. The tag will be matched to the hardware
address of the device and this mapping exposed to the guest OS via
cloud-init.</p>
<p>This additional metadata will help the guest OS users with multiple networks
interfaces to identify the devices that may have a specific role, such as a
network device dedicated to a specific service or a disk intended to be used by
a specific application (database, webcache, etc.)</p>
<p>This functionality already exists in platforms such as OpenStack. KubeVirt will
provide the data in a similar format, known to users and services like cloud-init.</p>
<p>For example:</p>
<pre><code>kind: VirtualMachineInstance
spec:
  domain:
    devices:
      interfaces:
      - masquerade: {}
        name: default
      - bridge: {}
        name: ptp
        tag: ptp
      - name: sriov-net
        sriov: {}
        tag: nfvfunc
  networks:
  - name: default
    pod: {}
  - multus:
      networkName: ptp-conf
    name: ptp
      networkName: sriov/sriov-network
    name: sriov-net

The metadata will be available in the guests config drive `openstack/latest/meta_data.json`

{
  &quot;devices&quot;: [
    {
        &quot;type&quot;: &quot;nic&quot;,
        &quot;bus&quot;: &quot;pci&quot;,
        &quot;address&quot;: &quot;0000:00:02.0&quot;,
        &quot;mac&quot;: &quot;01:22:22:42:22:21&quot;,
        &quot;tags&quot;: [&quot;ptp&quot;]
    },
    {
        &quot;type&quot;: &quot;nic&quot;,
        &quot;bus&quot;: &quot;pci&quot;,
        &quot;address&quot;: &quot;0000:81:10.1&quot;,
        &quot;mac&quot;: &quot;01:22:22:42:22:22&quot;,
        &quot;tags&quot;: [&quot;nfvfunc&quot;]
    },
  ]
}
</code></pre>
<h2 id="sysprep-examples">Sysprep Examples<a class="headerlink" href="#sysprep-examples" title="Permanent link">&para;</a></h2>
<h3 id="sysprep-in-a-configmap">Sysprep in a ConfigMap<a class="headerlink" href="#sysprep-in-a-configmap" title="Permanent link">&para;</a></h3>
<p>The answer file can be provided in a ConfigMap:</p>
<pre><code class="language-console">apiVersion: v1
kind: ConfigMap
metadata:
  name: sysprep-config
data:
  autounattend.xml: |
    &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
    &lt;unattend xmlns=&quot;urn:schemas-microsoft-com:unattend&quot;&gt;
    ...
    &lt;/unattend&gt;
</code></pre>
<p>And attached to the VM like so:</p>
<pre><code class="language-console">kind: VirtualMachine
metadata:
  name: windows-with-sysprep
spec:
  running: false
  template:
    metadata:
      labels:
        kubevirt.io/domain: windows-with-sysprep
    spec:
      domain:
        cpu:
          cores: 3
        devices:
          disks:
          - bootOrder: 1
            disk:
              bus: virtio
            name: harddrive
          - name: sysprep
            cdrom:
              bus: sata
        machine:
          type: q35
        resources:
          requests:
            memory: 6G
      volumes:
      - name: harddrive
        persistentVolumeClaim:
          claimName: windows_pvc
      - name: sysprep
        sysprep:
          configMap:
            name: sysprep-config
</code></pre>
<h3 id="sysprep-in-a-secret">Sysprep in a Secret<a class="headerlink" href="#sysprep-in-a-secret" title="Permanent link">&para;</a></h3>
<p>The answer file can be provided in a Secret:</p>
<pre><code class="language-console">apiVersion: v1
kind: Secret
metadata:
  name: sysprep-config
stringData:
data:
  autounattend.xml: |
    &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
    &lt;unattend xmlns=&quot;urn:schemas-microsoft-com:unattend&quot;&gt;
    ...
    &lt;/unattend&gt;
</code></pre>
<p>And attached to the VM like so:</p>
<pre><code class="language-console">kind: VirtualMachine
metadata:
  name: windows-with-sysprep
spec:
  running: false
  template:
    metadata:
      labels:
        kubevirt.io/domain: windows-with-sysprep
    spec:
      domain:
        cpu:
          cores: 3
        devices:
          disks:
          - bootOrder: 1
            disk:
              bus: virtio
            name: harddrive
          - name: sysprep
            cdrom:
              bus: sata
        machine:
          type: q35
        resources:
          requests:
            memory: 6G
      volumes:
      - name: harddrive
        persistentVolumeClaim:
          claimName: windows_pvc
      - name: sysprep
        sysprep:
          secret:
            name: sysprep-secret
</code></pre>
<h3 id="base-sysprep-vm">Base Sysprep VM<a class="headerlink" href="#base-sysprep-vm" title="Permanent link">&para;</a></h3>
<p>In the example below, a configMap with <code>autounattend.xml</code> file is used to modify the Windows iso image which is downloaded from Microsoft
and creates a base installed Windows machine with virtio drivers installed and all the commands executed in <code>post-install.ps1</code>
For the below manifests to work it needs to have <code>win10-iso</code> DataVolume.</p>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: win10-template-configmap
data:
  autounattend.xml: |-
    &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
    &lt;unattend xmlns=&quot;urn:schemas-microsoft-com:unattend&quot;&gt;
      &lt;settings pass=&quot;windowsPE&quot;&gt;
        &lt;component xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; name=&quot;Microsoft-Windows-International-Core-WinPE&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;&gt;
          &lt;SetupUILanguage&gt;
            &lt;UILanguage&gt;en-US&lt;/UILanguage&gt;
          &lt;/SetupUILanguage&gt;
          &lt;InputLocale&gt;0409:00000409&lt;/InputLocale&gt;
          &lt;SystemLocale&gt;en-US&lt;/SystemLocale&gt;
          &lt;UILanguage&gt;en-US&lt;/UILanguage&gt;
          &lt;UILanguageFallback&gt;en-US&lt;/UILanguageFallback&gt;
          &lt;UserLocale&gt;en-US&lt;/UserLocale&gt;
        &lt;/component&gt;
        &lt;component xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; name=&quot;Microsoft-Windows-PnpCustomizationsWinPE&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;&gt;
          &lt;DriverPaths&gt;
            &lt;PathAndCredentials wcm:keyValue=&quot;4b29ba63&quot; wcm:action=&quot;add&quot;&gt;
              &lt;Path&gt;E:\amd64\2k19&lt;/Path&gt;
            &lt;/PathAndCredentials&gt;
            &lt;PathAndCredentials wcm:keyValue=&quot;25fe51ea&quot; wcm:action=&quot;add&quot;&gt;
              &lt;Path&gt;E:\NetKVM\2k19\amd64&lt;/Path&gt;
            &lt;/PathAndCredentials&gt;
          &lt;/DriverPaths&gt;
        &lt;/component&gt;
        &lt;component xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; name=&quot;Microsoft-Windows-Setup&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;&gt;
          &lt;DiskConfiguration&gt;
            &lt;Disk wcm:action=&quot;add&quot;&gt;
              &lt;CreatePartitions&gt;
                &lt;CreatePartition wcm:action=&quot;add&quot;&gt;
                  &lt;Order&gt;1&lt;/Order&gt;
                  &lt;Type&gt;Primary&lt;/Type&gt;
                  &lt;Size&gt;100&lt;/Size&gt;
                &lt;/CreatePartition&gt;
                &lt;CreatePartition wcm:action=&quot;add&quot;&gt;
                  &lt;Extend&gt;true&lt;/Extend&gt;
                  &lt;Order&gt;2&lt;/Order&gt;
                  &lt;Type&gt;Primary&lt;/Type&gt;
                &lt;/CreatePartition&gt;
              &lt;/CreatePartitions&gt;
              &lt;ModifyPartitions&gt;
                &lt;ModifyPartition wcm:action=&quot;add&quot;&gt;
                  &lt;Format&gt;NTFS&lt;/Format&gt;
                  &lt;Label&gt;System Reserved&lt;/Label&gt;
                  &lt;Order&gt;1&lt;/Order&gt;
                  &lt;PartitionID&gt;1&lt;/PartitionID&gt;
                  &lt;TypeID&gt;0x27&lt;/TypeID&gt;
                &lt;/ModifyPartition&gt;
                &lt;ModifyPartition wcm:action=&quot;add&quot;&gt;
                  &lt;Format&gt;NTFS&lt;/Format&gt;
                  &lt;Label&gt;OS&lt;/Label&gt;
                  &lt;Letter&gt;C&lt;/Letter&gt;
                  &lt;Order&gt;2&lt;/Order&gt;
                  &lt;PartitionID&gt;2&lt;/PartitionID&gt;
                &lt;/ModifyPartition&gt;
              &lt;/ModifyPartitions&gt;
              &lt;DiskID&gt;0&lt;/DiskID&gt;
              &lt;WillWipeDisk&gt;true&lt;/WillWipeDisk&gt;
            &lt;/Disk&gt;
          &lt;/DiskConfiguration&gt;
          &lt;ImageInstall&gt;
            &lt;OSImage&gt;
              &lt;InstallFrom&gt;
                &lt;MetaData wcm:action=&quot;add&quot;&gt;
                  &lt;Key&gt;/Image/Description&lt;/Key&gt;
                  &lt;Value&gt;Windows 10 Pro&lt;/Value&gt;
                &lt;/MetaData&gt;
              &lt;/InstallFrom&gt;
              &lt;InstallTo&gt;
                &lt;DiskID&gt;0&lt;/DiskID&gt;
                &lt;PartitionID&gt;2&lt;/PartitionID&gt;
              &lt;/InstallTo&gt;
            &lt;/OSImage&gt;
          &lt;/ImageInstall&gt;
          &lt;UserData&gt;
            &lt;AcceptEula&gt;true&lt;/AcceptEula&gt;
            &lt;FullName/&gt;
            &lt;Organization/&gt;
            &lt;ProductKey&gt;
              &lt;Key/&gt;
            &lt;/ProductKey&gt;
          &lt;/UserData&gt;
        &lt;/component&gt;
      &lt;/settings&gt;
      &lt;settings pass=&quot;offlineServicing&quot;&gt;
        &lt;component xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; name=&quot;Microsoft-Windows-LUA-Settings&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;&gt;
          &lt;EnableLUA&gt;false&lt;/EnableLUA&gt;
        &lt;/component&gt;
      &lt;/settings&gt;
      &lt;settings pass=&quot;specialize&quot;&gt;
        &lt;component xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; name=&quot;Microsoft-Windows-International-Core&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;&gt;
          &lt;InputLocale&gt;0409:00000409&lt;/InputLocale&gt;
          &lt;SystemLocale&gt;en-US&lt;/SystemLocale&gt;
          &lt;UILanguage&gt;en-US&lt;/UILanguage&gt;
          &lt;UILanguageFallback&gt;en-US&lt;/UILanguageFallback&gt;
          &lt;UserLocale&gt;en-US&lt;/UserLocale&gt;
        &lt;/component&gt;
        &lt;component xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; name=&quot;Microsoft-Windows-Security-SPP-UX&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;&gt;
          &lt;SkipAutoActivation&gt;true&lt;/SkipAutoActivation&gt;
        &lt;/component&gt;
        &lt;component xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; name=&quot;Microsoft-Windows-SQMApi&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;&gt;
          &lt;CEIPEnabled&gt;0&lt;/CEIPEnabled&gt;
        &lt;/component&gt;
      &lt;/settings&gt;
      &lt;settings pass=&quot;oobeSystem&quot;&gt;
        &lt;component xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; name=&quot;Microsoft-Windows-Shell-Setup&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;&gt;
          &lt;OOBE&gt;
            &lt;HideEULAPage&gt;true&lt;/HideEULAPage&gt;
            &lt;HideOEMRegistrationScreen&gt;true&lt;/HideOEMRegistrationScreen&gt;
            &lt;HideOnlineAccountScreens&gt;true&lt;/HideOnlineAccountScreens&gt;
            &lt;HideWirelessSetupInOOBE&gt;true&lt;/HideWirelessSetupInOOBE&gt;
            &lt;NetworkLocation&gt;Work&lt;/NetworkLocation&gt;
            &lt;SkipUserOOBE&gt;true&lt;/SkipUserOOBE&gt;
            &lt;SkipMachineOOBE&gt;true&lt;/SkipMachineOOBE&gt;
            &lt;ProtectYourPC&gt;3&lt;/ProtectYourPC&gt;
          &lt;/OOBE&gt;
          &lt;AutoLogon&gt;
            &lt;Password&gt;
              &lt;Value&gt;123456&lt;/Value&gt;
              &lt;PlainText&gt;true&lt;/PlainText&gt;
            &lt;/Password&gt;
            &lt;Enabled&gt;true&lt;/Enabled&gt;
            &lt;Username&gt;Administrator&lt;/Username&gt;
          &lt;/AutoLogon&gt;
          &lt;UserAccounts&gt;
            &lt;AdministratorPassword&gt;
              &lt;Value&gt;123456&lt;/Value&gt;
              &lt;PlainText&gt;true&lt;/PlainText&gt;
            &lt;/AdministratorPassword&gt;
          &lt;/UserAccounts&gt;
          &lt;RegisteredOrganization/&gt;
          &lt;RegisteredOwner/&gt;
          &lt;TimeZone&gt;Eastern Standard Time&lt;/TimeZone&gt;
          &lt;FirstLogonCommands&gt;
            &lt;SynchronousCommand wcm:action=&quot;add&quot;&gt;
              &lt;CommandLine&gt;powershell -ExecutionPolicy Bypass -NoExit -NoProfile f:\post-install.ps1&lt;/CommandLine&gt;
              &lt;RequiresUserInput&gt;false&lt;/RequiresUserInput&gt;
              &lt;Order&gt;1&lt;/Order&gt;
              &lt;Description&gt;Post Installation Script&lt;/Description&gt;
            &lt;/SynchronousCommand&gt;
          &lt;/FirstLogonCommands&gt;
        &lt;/component&gt;
      &lt;/settings&gt;
    &lt;/unattend&gt;


  post-install.ps1: |-
    # Remove AutoLogin
    # https://docs.microsoft.com/en-us/windows-hardware/customize/desktop/unattend/microsoft-windows-shell-setup-autologon-logoncount#logoncount-known-issue
    reg add &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&quot; /v AutoAdminLogon /t REG_SZ /d 0 /f

    # install Qemu Tools (Drivers)
    Start-Process msiexec -Wait -ArgumentList '/i e:\virtio-win-gt-x64.msi /qn /passive /norestart'

    # install Guest Agent
    Start-Process msiexec -Wait -ArgumentList '/i e:\guest-agent\qemu-ga-x86_64.msi /qn /passive /norestart'

    # Rename cached unattend.xml to avoid it is picked up by sysprep
    mv C:\Windows\Panther\unattend.xml C:\Windows\Panther\unattend.install.xml

    # Eject CD, to avoid that the autounattend.xml on the CD is picked up by sysprep
    (new-object -COM Shell.Application).NameSpace(17).ParseName('F:').InvokeVerb('Eject')

    # Run Sysprep and Shutdown
    C:\Windows\System32\Sysprep\sysprep.exe /generalize /oobe /shutdown /mode:vm

---

apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  annotations:
    name.os.template.kubevirt.io/win10: Microsoft Windows 10
    vm.kubevirt.io/validations: |
      [
        {
          &quot;name&quot;: &quot;minimal-required-memory&quot;,
          &quot;path&quot;: &quot;jsonpath::.spec.domain.resources.requests.memory&quot;,
          &quot;rule&quot;: &quot;integer&quot;,
          &quot;message&quot;: &quot;This VM requires more memory.&quot;,
          &quot;min&quot;: 2147483648
        }, {
          &quot;name&quot;: &quot;windows-virtio-bus&quot;,
          &quot;path&quot;: &quot;jsonpath::.spec.domain.devices.disks[*].disk.bus&quot;,
          &quot;valid&quot;: &quot;jsonpath::.spec.domain.devices.disks[*].disk.bus&quot;,
          &quot;rule&quot;: &quot;enum&quot;,
          &quot;message&quot;: &quot;virto disk bus type has better performance, install virtio drivers in VM and change bus type&quot;,
          &quot;values&quot;: [&quot;virtio&quot;],
          &quot;justWarning&quot;: true
        }, {
          &quot;name&quot;: &quot;windows-disk-bus&quot;,
          &quot;path&quot;: &quot;jsonpath::.spec.domain.devices.disks[*].disk.bus&quot;,
          &quot;valid&quot;: &quot;jsonpath::.spec.domain.devices.disks[*].disk.bus&quot;,
          &quot;rule&quot;: &quot;enum&quot;,
          &quot;message&quot;: &quot;disk bus has to be either virtio or sata or scsi&quot;,
          &quot;values&quot;: [&quot;virtio&quot;, &quot;sata&quot;, &quot;scsi&quot;]
        }, {
          &quot;name&quot;: &quot;windows-cd-bus&quot;,
          &quot;path&quot;: &quot;jsonpath::.spec.domain.devices.disks[*].cdrom.bus&quot;,
          &quot;valid&quot;: &quot;jsonpath::.spec.domain.devices.disks[*].cdrom.bus&quot;,
          &quot;rule&quot;: &quot;enum&quot;,
          &quot;message&quot;: &quot;cd bus has to be sata&quot;,
          &quot;values&quot;: [&quot;sata&quot;]
        }
      ]
  name: win10-template
  namespace: default
  labels:
    app: win10-template
    flavor.template.kubevirt.io/medium: 'true'
    os.template.kubevirt.io/win10: 'true'
    vm.kubevirt.io/template: windows10-desktop-medium
    vm.kubevirt.io/template.namespace: openshift
    vm.kubevirt.io/template.revision: '1'
    vm.kubevirt.io/template.version: v0.14.0
    workload.template.kubevirt.io/desktop: 'true'
spec:
  runStrategy: RerunOnFailure
  dataVolumeTemplates:
    - metadata:
        name: win10-template-windows-iso
      spec:
        pvc:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
        source:
          pvc:
            name: windows10-iso
            namespace: default
    - metadata:
        name: win10-template
      spec:
        pvc:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 25Gi
          volumeMode: Filesystem
        source:
          blank: {}
  template:
    metadata:
      annotations:
        vm.kubevirt.io/flavor: medium
        vm.kubevirt.io/os: windows10
        vm.kubevirt.io/workload: desktop
      labels:
        flavor.template.kubevirt.io/medium: 'true'
        kubevirt.io/domain: win10-template
        kubevirt.io/size: medium
        os.template.kubevirt.io/win10: 'true'
        vm.kubevirt.io/name: win10-template
        workload.template.kubevirt.io/desktop: 'true'
    spec:
      domain:
        clock:
          timer:
            hpet:
              present: false
            hyperv: {}
            pit:
              tickPolicy: delay
            rtc:
              tickPolicy: catchup
          utc: {}
        cpu:
          cores: 1
          sockets: 1
          threads: 1
        devices:
          disks:
            - bootOrder: 1
              disk:
                bus: virtio
              name: win10-template
            - bootOrder: 2
              cdrom:
                bus: sata
              name: windows-iso
            - cdrom:
                bus: sata
              name: windows-guest-tools
            - name: sysprep
              cdrom:
                bus: sata
          inputs:
            - bus: usb
              name: tablet
              type: tablet
          interfaces:
            - masquerade: {}
              model: virtio
              name: default
        features:
          acpi: {}
          apic: {}
          hyperv:
            reenlightenment: {}
            ipi: {}
            synic: {}
            synictimer:
              direct: {}
            spinlocks:
              spinlocks: 8191
            reset: {}
            relaxed: {}
            vpindex: {}
            runtime: {}
            tlbflush: {}
            frequencies: {}
            vapic: {}
        machine:
          type: pc-q35-rhel8.4.0
        resources:
          requests:
            memory: 4Gi
      hostname: win10-template
      networks:
        - name: default
          pod: {}
      volumes:
        - dataVolume:
            name: win10-iso
          name: windows-iso
        - dataVolume:
            name: win10-template-windows-iso
          name: win10-template
        - containerDisk:
            image: quay.io/kubevirt/virtio-container-disk
          name: windows-guest-tools
        - name: sysprep
          sysprep:
            configMap:
              name: win10-template-configmap

</code></pre>
<h3 id="launching-a-vm-from-template">Launching a VM from template<a class="headerlink" href="#launching-a-vm-from-template" title="Permanent link">&para;</a></h3>
<p>From the above example after the sysprep command is executed in the <code>post-install.ps1</code> and the vm is in shutdown state,
A new VM can be launched from the base <code>win10-template</code> with additional changes mentioned from the below <code>unattend.xml</code> in <code>sysprep-config</code>.
The new VM can take upto 5 minutes to be in running state since Windows goes through oobe setup in the background with the customizations specified in the below <code>unattend.xml</code> file.</p>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: sysprep-config
data:
  autounattend.xml: |-
    &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
    &lt;!-- responsible for installing windows, ignored on sysprepped images --&gt;
  unattend.xml: |-
    &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
    &lt;unattend xmlns=&quot;urn:schemas-microsoft-com:unattend&quot;&gt;
      &lt;settings pass=&quot;oobeSystem&quot;&gt;
        &lt;component xmlns:wcm=&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; name=&quot;Microsoft-Windows-Shell-Setup&quot; processorArchitecture=&quot;amd64&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; language=&quot;neutral&quot; versionScope=&quot;nonSxS&quot;&gt;
          &lt;OOBE&gt;
            &lt;HideEULAPage&gt;true&lt;/HideEULAPage&gt;
            &lt;HideOEMRegistrationScreen&gt;true&lt;/HideOEMRegistrationScreen&gt;
            &lt;HideOnlineAccountScreens&gt;true&lt;/HideOnlineAccountScreens&gt;
            &lt;HideWirelessSetupInOOBE&gt;true&lt;/HideWirelessSetupInOOBE&gt;
            &lt;NetworkLocation&gt;Work&lt;/NetworkLocation&gt;
            &lt;SkipUserOOBE&gt;true&lt;/SkipUserOOBE&gt;
            &lt;SkipMachineOOBE&gt;true&lt;/SkipMachineOOBE&gt;
            &lt;ProtectYourPC&gt;3&lt;/ProtectYourPC&gt;
          &lt;/OOBE&gt;
          &lt;AutoLogon&gt;
            &lt;Password&gt;
            &lt;Value&gt;123456&lt;/Value&gt;
              &lt;PlainText&gt;true&lt;/PlainText&gt;
            &lt;/Password&gt;
            &lt;Enabled&gt;true&lt;/Enabled&gt;
        &lt;Username&gt;Administrator&lt;/Username&gt;
    &lt;/AutoLogon&gt;
    &lt;UserAccounts&gt;
         &lt;AdministratorPassword&gt;
                &lt;Value&gt;123456&lt;/Value&gt;
                &lt;PlainText&gt;true&lt;/PlainText&gt;
        &lt;/AdministratorPassword&gt;
          &lt;/UserAccounts&gt;
          &lt;RegisteredOrganization&gt;Kuebvirt&lt;/RegisteredOrganization&gt;
          &lt;RegisteredOwner&gt;Kubevirt&lt;/RegisteredOwner&gt;
          &lt;TimeZone&gt;Eastern Standard Time&lt;/TimeZone&gt;
                &lt;FirstLogonCommands&gt;
                    &lt;SynchronousCommand wcm:action=&quot;add&quot;&gt;
                    &lt;CommandLine&gt;powershell -ExecutionPolicy Bypass -NoExit -WindowStyle Hidden -NoProfile d:\customize.ps1&lt;/CommandLine&gt;
                        &lt;RequiresUserInput&gt;false&lt;/RequiresUserInput&gt;
                        &lt;Order&gt;1&lt;/Order&gt;
                &lt;Description&gt;Customize Script&lt;/Description&gt;
            &lt;/SynchronousCommand&gt;
                &lt;/FirstLogonCommands&gt;
        &lt;/component&gt;
      &lt;/settings&gt;
    &lt;/unattend&gt;
  customize.ps1: |-
    # Enable RDP
    Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name &quot;fDenyTSConnections&quot; -value 0
    Enable-NetFirewallRule -DisplayGroup &quot;Remote Desktop&quot;


    # https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse
    # Install the OpenSSH Server
    Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
    # Start the sshd service
    Start-Service sshd

    Set-Service -Name sshd -StartupType 'Automatic'

    # https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_server_configuration
    # use powershell as default shell for ssh
    New-ItemProperty -Path &quot;HKLM:\SOFTWARE\OpenSSH&quot; -Name DefaultShell -Value &quot;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&quot; -PropertyType String -Force


    # Add ssh authorized_key for administrator
    # https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_keymanagement
    $MyDir = $MyInvocation.MyCommand.Path | Split-Path -Parent
    $PublicKey = Get-Content -Path $MyDir\id_rsa.pub
    $authrized_keys_path = $env:ProgramData + &quot;\ssh\administrators_authorized_keys&quot; 
    Add-Content -Path $authrized_keys_path -Value $PublicKey
    icacls.exe $authrized_keys_path /inheritance:r /grant &quot;Administrators:F&quot; /grant &quot;SYSTEM:F&quot;


    # install application via exe file installer from url
    function Install-Exe {
      $dlurl = $args[0]
      $installerPath = Join-Path $env:TEMP (Split-Path $dlurl -Leaf)
      Invoke-WebRequest -UseBasicParsing $dlurl -OutFile $installerPath
      Start-Process -FilePath $installerPath -Args &quot;/S&quot; -Verb RunAs -Wait
      Remove-Item $installerPath

    }

    # Wait for networking before running a task at startup
    do {
      $ping = test-connection -comp kubevirt.io -count 1 -Quiet
    } until ($ping)

    # Installing the Latest Notepad++ with PowerShell
    $BaseUri = &quot;https://notepad-plus-plus.org&quot;
    $BasePage = Invoke-WebRequest -Uri $BaseUri -UseBasicParsing
    $ChildPath = $BasePage.Links | Where-Object { $_.outerHTML -like '*Current Version*' } | Select-Object -ExpandProperty href
    $DownloadPageUri = $BaseUri + $ChildPath
    $DownloadPage = Invoke-WebRequest -Uri $DownloadPageUri -UseBasicParsing
    $DownloadUrl = $DownloadPage.Links | Where-Object { $_.outerHTML -like '*npp.*.Installer.x64.exe&quot;*' } | Select-Object -ExpandProperty href
    Install-Exe $DownloadUrl
  id_rsa.pub: |-
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6zdgFiLr1uAK7PdcchDd+LseA5fEOcxCCt7TLlr7Mx6h8jUg+G+8L9JBNZuDzTZSF0dR7qwzdBBQjorAnZTmY3BhsKcFr8Gt4KMGrS6r3DNmGruP8GORvegdWZuXgASKVpXeI7nCIjRJwAaK1x+eGHwAWO9Z8ohcboHbLyffOoSZDSIuk2kRIc47+ENRjg0T6x2VRsqX27g6j4DfPKQZGk0zvXkZaYtr1e2tZgqTBWqZUloMJK8miQq6MktCKAS4VtPk0k7teQX57OGwD6D7uo4b+Cl8aYAAwhn0hc0C2USfbuVHgq88ESo2/+NwV4SQcl3sxCW21yGIjAGt4Hy7J fedora@localhost.localdomain


</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../accessing_virtual_machines/" class="btn btn-neutral float-left" title="Accessing Virtual Machines"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../service_objects/" class="btn btn-neutral float-right" title="Service objects">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/kubevirt/user-guide/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../accessing_virtual_machines/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../service_objects/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

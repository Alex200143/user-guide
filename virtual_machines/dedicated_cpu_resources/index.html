<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://kubevirt.io/user-guide/virtual_machines/dedicated_cpu_resources/" />
      <link rel="shortcut icon" href="../../assets/favicon.ico" />
    <title>Dedicated CPU resources - KubeVirt User-Guide</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Dedicated CPU resources";
        var mkdocs_page_input_path = "virtual_machines/dedicated_cpu_resources.md";
        var mkdocs_page_url = "/user-guide/virtual_machines/dedicated_cpu_resources/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> KubeVirt User-Guide
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Welcome</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../quickstarts/">Quickstarts</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../release_notes/">KubeVirt release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Operations</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/updating_and_deletion/">Updating and deletion</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/basic_use/">Basic use</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/customize_components/">Customize components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/api_validation/">API Validation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/debug/">Debug</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/virtctl_client_tool/">virtctl Client Tool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/live_migration/">Live Migration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/hotplug_volumes/">Hotplug Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/snapshot_restore_api/">Snapshot Restore API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/hugepages/">Hugepages support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/component_monitoring/">Component monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/authorization/">Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/annotations_and_labels/">Annotations and labels</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_assignment/">Node assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_maintenance/">Node maintenance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/node_overcommit/">Node overcommit</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/unresponsive_nodes/">Unresponsive nodes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/containerized_data_importer/">Containerized Data Importer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/activating_feature_gates/">Activating feature gates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/export_api/">Export API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/clone_api/">Clone API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/memory_dump/">Virtual machine memory dump</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/mediated_devices_configuration/">Mediated devices and virtual GPUs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../operations/migration_policies/">Migration Policies</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Virtual machines</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../virtual_machine_instances/">Virtual Machines Instances</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lifecycle/">Lifecycle</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../run_strategies/">Run Strategies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../instancetypes/">Instancetypes and preferences</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../presets/">Presets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../virtual_hardware/">Virtual hardware</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Dedicated CPU resources</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#kubernetes-cpu-manager">Kubernetes CPU manager</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#requesting-dedicated-cpu-resources">Requesting dedicated CPU resources</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#requesting-dedicated-cpu-for-qemu-emulator">Requesting dedicated CPU for QEMU emulator</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#identifying-nodes-with-a-running-cpu-manager">Identifying nodes with a running CPU manager</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sidecar-containers-and-cpu-allocation-overhead">Sidecar containers and CPU allocation overhead</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../numa/">NUMA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../disks_and_volumes/">Disks and Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../interfaces_and_networks/">Interfaces and Networks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../istio_service_mesh/">Istio service mesh</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../networkpolicy/">NetworkPolicy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../host-devices/">Host Devices Assignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../windows_virtio_drivers/">Windows virtio drivers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guest_operating_system_information/">Guest Operating System Information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guest_agent_information/">Guest Agent information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../liveness_and_readiness_probes/">Liveness and Readiness Probes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../accessing_virtual_machines/">Accessing Virtual Machines</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../startup_scripts/">Startup Scripts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../service_objects/">Service objects</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../templates/">Templates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tekton_tasks/">KubeVirt Tekton</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../replicaset/">VirtualMachineInstanceReplicaSet</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dns/">DNS records</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../boot_from_external_source/">Booting From External Source</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../confidential_computing/">Confidential computing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../vsock/">VSOCK</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../web_console/">Web Console</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/contributing/">Contributing</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">KubeVirt User-Guide</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Virtual machines &raquo;</li>
      <li>Dedicated CPU resources</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/kubevirt/user-guide/edit/main/docs/virtual_machines/dedicated_cpu_resources.md"
          class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="dedicated-cpu-resources">Dedicated CPU resources<a class="headerlink" href="#dedicated-cpu-resources" title="Permanent link">&para;</a></h1>
<p>Certain workloads, requiring a predictable latency and enhanced
performance during its execution would benefit from obtaining dedicated
CPU resources. KubeVirt, relying on the Kubernetes CPU manager, is able
to pin guest's vCPUs to the host's pCPUs.</p>
<h2 id="kubernetes-cpu-manager"><a href="https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/">Kubernetes CPU manager</a><a class="headerlink" href="#kubernetes-cpu-manager" title="Permanent link">&para;</a></h2>
<p>Kubernetes CPU manager is a mechanism that affects the scheduling of
workloads, placing it on a host which can allocate <code>Guaranteed</code>
resources and pin certain Pod's containers to host pCPUs, if the
following requirements are met:</p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/#create-a-pod-that-gets-assigned-a-qos-class-of-guaranteed">Pod's QoS</a> is Guaranteed<ul>
<li>resources requests and limits are equal</li>
<li>all containers in the Pod express CPU and memory requirements</li>
</ul>
</li>
<li>Requested number of CPUs is an Integer</li>
</ul>
<p>Additional information: </p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/">Enabling the CPU manager on Kubernetes</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.10/scalability_and_performance/using-cpu-manager.html">Enabling the CPU manager on OKD</a></li>
<li><a href="https://kubernetes.io/blog/2018/07/24/feature-highlight-cpu-manager/">Kubernetes blog explaining the feature</a></li>
</ul>
<h2 id="requesting-dedicated-cpu-resources">Requesting dedicated CPU resources<a class="headerlink" href="#requesting-dedicated-cpu-resources" title="Permanent link">&para;</a></h2>
<p>Setting <code>spec.domain.cpu.dedicatedCpuPlacement</code> to <code>true</code> in a VMI spec
will indicate the desire to allocate dedicated CPU resource to the VMI</p>
<p>Kubevirt will verify that all the necessary conditions are met, for the
Kubernetes CPU manager to pin the virt-launcher container to dedicated
host CPUs. Once, virt-launcher is running, the VMI's vCPUs will be
pinned to the pCPUS that has been dedicated for the virt-launcher
container.</p>
<p>Expressing the desired amount of VMI's vCPUs can be done by either
setting the guest topology in <code>spec.domain.cpu</code> (<code>sockets</code>, <code>cores</code>,
<code>threads</code>) or <code>spec.domain.resources.[requests/limits].cpu</code> to a whole
number integer ([1-9]+) indicating the number of vCPUs
requested for the VMI. Number of vCPUs is counted as
<code>sockets * cores * threads</code> or if <code>spec.domain.cpu</code> is empty then it
takes value from <code>spec.domain.resources.requests.cpu</code> or
<code>spec.domain.resources.limits.cpu</code>.</p>
<blockquote>
<p><strong>Note:</strong> Users should not specify both <code>spec.domain.cpu</code> and
<code>spec.domain.resources.[requests/limits].cpu</code></p>
<p><strong>Note:</strong> <code>spec.domain.resources.requests.cpu</code> must be equal to
<code>spec.domain.resources.limits.cpu</code></p>
<p><strong>Note:</strong> Multiple cpu-bound microbenchmarks show a significant
performance advantage when using <code>spec.domain.cpu.sockets</code> instead of
<code>spec.domain.cpu.cores</code>.</p>
</blockquote>
<p>All inconsistent requirements will be rejected.</p>
<pre><code>apiVersion: kubevirt.io/v1
kind: VirtualMachineInstance
spec:
  domain:
    cpu:
      sockets: 2
      cores: 1
      threads: 1
      dedicatedCpuPlacement: true
    resources:
      limits:
        memory: 2Gi
[...]
</code></pre>
<p>OR</p>
<pre><code>apiVersion: kubevirt.io/v1
kind: VirtualMachineInstance
spec:
  domain:
    cpu:
      dedicatedCpuPlacement: true
    resources:
      limits:
        cpu: 2
        memory: 2Gi
[...]
</code></pre>
<h2 id="requesting-dedicated-cpu-for-qemu-emulator">Requesting dedicated CPU for QEMU emulator<a class="headerlink" href="#requesting-dedicated-cpu-for-qemu-emulator" title="Permanent link">&para;</a></h2>
<p>A number of QEMU threads, such as QEMU main event loop, async I/O
operation completion, etc., also execute on the same physical CPUs as
the VMI's vCPUs. This may affect the expected latency of a vCPU. In
order to enhance the real-time support in KubeVirt and provide improved
latency, KubeVirt will allocate an additional dedicated CPU, exclusively
for the emulator thread, to which it will be pinned. This will
effectively "isolate" the emulator thread from the vCPUs of the VMI.
In case <code>ioThreadsPolicy</code> is set to <code>auto</code> IOThreads will also be
"isolated" and placed on the same physical CPU as the QEMU emulator thread.</p>
<p>This functionality can be enabled by specifying
<code>isolateEmulatorThread: true</code> inside VMI spec's <code>Spec.Domain.CPU</code>
section. Naturally, this setting has to be specified in a combination
with a <code>dedicatedCpuPlacement: true</code>.</p>
<p>Example:</p>
<pre><code>apiVersion: kubevirt.io/v1
kind: VirtualMachineInstance
spec:
  domain:
    cpu:
      dedicatedCpuPlacement: true
      isolateEmulatorThread: true
    resources:
      limits:
        cpu: 2
        memory: 2Gi
</code></pre>
<h2 id="identifying-nodes-with-a-running-cpu-manager">Identifying nodes with a running CPU manager<a class="headerlink" href="#identifying-nodes-with-a-running-cpu-manager" title="Permanent link">&para;</a></h2>
<p>At this time, <a href="https://github.com/kubernetes/kubernetes/issues/66525">Kubernetes doesn't label the
nodes</a> that has
CPU manager running on it.</p>
<p>KubeVirt has a mechanism to identify which nodes has the CPU manager
running and manually add a <code>cpumanager=true</code> label. This label will be
removed when KubeVirt will identify that CPU manager is no longer
running on the node. This automatic identification should be viewed as a
temporary workaround until Kubernetes will provide the required
functionality. Therefore, this feature should be manually enabled by
activating the <code>CPUManager</code>
<a href="../../operations/activating_feature_gates/#how-to-activate-a-feature-gate">feature gate</a>
to the KubeVirt CR.</p>
<p>When automatic identification is disabled, cluster administrator may
manually add the above label to all the nodes when CPU Manager is
running.</p>
<ul>
<li>
<p>Nodes' labels are view-able: <code>kubectl describe nodes</code></p>
</li>
<li>
<p>Administrators may manually label a missing node:
    <code>kubectl label node [node_name] cpumanager=true</code></p>
</li>
</ul>
<h2 id="sidecar-containers-and-cpu-allocation-overhead">Sidecar containers and CPU allocation overhead<a class="headerlink" href="#sidecar-containers-and-cpu-allocation-overhead" title="Permanent link">&para;</a></h2>
<p><strong>Note:</strong> In order to run sidecar containers, KubeVirt requires the
<code>Sidecar</code>
<a href="../../operations/activating_feature_gates/#how-to-activate-a-feature-gate">feature gate</a>
to be enabled in KubeVirt's CR.</p>
<p>According to the Kubernetes CPU manager model, in order the POD would
reach the required QOS level <code>Guaranteed</code>, all containers in the POD
must express CPU and memory requirements. At this time, Kubevirt often
uses a sidecar container to mount VMI's registry disk. It also uses a
sidecar container of it's hooking mechanism. These additional resources
can be viewed as an overhead and should be taken into account when
calculating a node capacity.</p>
<p><strong>Note:</strong> The current defaults for sidecar's resources: <code>CPU: 200m</code>
<code>Memory: 64M</code> As the CPU resource is not expressed as a whole number,
CPU manager will not attempt to pin the sidecar container to a host CPU.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../virtual_hardware/" class="btn btn-neutral float-left" title="Virtual hardware"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../numa/" class="btn btn-neutral float-right" title="NUMA">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/kubevirt/user-guide/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../virtual_hardware/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../numa/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
